<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Motorsport Manager</title>
<style>
:root {
  --bg-main: #0a0e17;
  --bg-card: #111827;
  --bg-card-hover: #1a2332;
  --bg-sidebar: #0d1320;
  --bg-modal: #0f1629;
  --border: #1e293b;
  --border-bright: #334155;
  --text: #e2e8f0;
  --text-dim: #94a3b8;
  --text-muted: #64748b;
  --accent: #06b6d4;
  --accent-dim: #0891b2;
  --accent-glow: rgba(6,182,212,0.15);
  --green: #22c55e;
  --green-dim: #16a34a;
  --red: #ef4444;
  --red-dim: #dc2626;
  --yellow: #eab308;
  --orange: #f97316;
  --purple: #a855f7;
  --gold: #fbbf24;
  --silver: #9ca3af;
  --bronze: #d97706;
}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg-main);color:var(--text);font-family:'Segoe UI',system-ui,sans-serif;overflow:hidden;height:100vh;width:100vw}
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:var(--bg-main)}
::-webkit-scrollbar-thumb{background:var(--border-bright);border-radius:3px}

/* â”€â”€â”€ LAYOUT â”€â”€â”€ */
#app{display:flex;flex-direction:column;height:100vh;width:100vw}
#topbar{display:flex;align-items:center;justify-content:space-between;padding:8px 20px;background:var(--bg-sidebar);border-bottom:1px solid var(--border);height:48px;flex-shrink:0}
#topbar .logo{font-size:18px;font-weight:700;letter-spacing:1px;color:var(--accent)}
#topbar .logo span{color:var(--text-dim);font-weight:400}
#topbar .info{display:flex;gap:20px;font-size:13px;color:var(--text-dim)}
#topbar .info .val{color:var(--text);font-weight:600}

#main{display:flex;flex:1;overflow:hidden}
#sidebar{width:220px;background:var(--bg-sidebar);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0}
#sidebar .nav-item{padding:12px 18px;cursor:pointer;font-size:14px;border-left:3px solid transparent;transition:all .15s;display:flex;align-items:center;gap:10px}
#sidebar .nav-item:hover{background:var(--bg-card-hover);border-left-color:var(--border-bright)}
#sidebar .nav-item.active{background:var(--accent-glow);border-left-color:var(--accent);color:var(--accent)}
#sidebar .nav-item .icon{width:20px;text-align:center;font-size:16px}
#sidebar .nav-section{font-size:10px;text-transform:uppercase;letter-spacing:2px;color:var(--text-muted);padding:16px 18px 6px}

#content{flex:1;overflow-y:auto;padding:24px 32px}

/* â”€â”€â”€ CARDS â”€â”€â”€ */
.card{background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:20px;margin-bottom:16px}
.card-header{font-size:16px;font-weight:600;margin-bottom:12px;display:flex;align-items:center;justify-content:space-between}
.card-header .badge{font-size:11px;padding:3px 10px;border-radius:12px;font-weight:600}

/* â”€â”€â”€ TABLES â”€â”€â”€ */
table{width:100%;border-collapse:collapse;font-size:13px}
th{text-align:left;color:var(--text-muted);font-weight:500;font-size:11px;text-transform:uppercase;letter-spacing:1px;padding:8px 10px;border-bottom:1px solid var(--border)}
td{padding:8px 10px;border-bottom:1px solid rgba(30,41,59,.5)}
tr:hover td{background:rgba(6,182,212,.03)}

/* â”€â”€â”€ BUTTONS â”€â”€â”€ */
.btn{padding:8px 18px;border:none;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;transition:all .15s;display:inline-flex;align-items:center;gap:6px}
.btn-primary{background:var(--accent);color:#000}
.btn-primary:hover{background:var(--accent-dim);transform:translateY(-1px)}
.btn-secondary{background:var(--bg-card);color:var(--text);border:1px solid var(--border)}
.btn-secondary:hover{border-color:var(--accent);color:var(--accent)}
.btn-danger{background:var(--red-dim);color:#fff}
.btn-danger:hover{background:var(--red)}
.btn-success{background:var(--green-dim);color:#fff}
.btn-success:hover{background:var(--green)}
.btn-small{padding:5px 12px;font-size:12px}
.btn:disabled{opacity:.4;cursor:not-allowed;transform:none!important}

/* â”€â”€â”€ BARS â”€â”€â”€ */
.bar-wrap{height:6px;background:rgba(255,255,255,.06);border-radius:3px;overflow:hidden;flex:1}
.bar-fill{height:100%;border-radius:3px;transition:width .3s}
.bar-cyan .bar-fill{background:var(--accent)}
.bar-green .bar-fill{background:var(--green)}
.bar-red .bar-fill{background:var(--red)}
.bar-yellow .bar-fill{background:var(--yellow)}
.bar-orange .bar-fill{background:var(--orange)}

/* â”€â”€â”€ SKILL BADGE â”€â”€â”€ */
.skill-badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:12px;font-weight:700;min-width:32px;text-align:center}
.skill-low{background:rgba(239,68,68,.15);color:var(--red)}
.skill-mid{background:rgba(234,179,8,.15);color:var(--yellow)}
.skill-high{background:rgba(34,197,94,.15);color:var(--green)}
.skill-elite{background:rgba(168,85,247,.15);color:var(--purple)}

/* â”€â”€â”€ TABS â”€â”€â”€ */
.tabs{display:flex;gap:2px;margin-bottom:16px;border-bottom:1px solid var(--border)}
.tab{padding:8px 16px;cursor:pointer;font-size:13px;color:var(--text-muted);border-bottom:2px solid transparent;transition:all .15s}
.tab:hover{color:var(--text)}
.tab.active{color:var(--accent);border-bottom-color:var(--accent)}

/* â”€â”€â”€ GRID â”€â”€â”€ */
.grid{display:grid;gap:16px}
.grid-2{grid-template-columns:1fr 1fr}
.grid-3{grid-template-columns:1fr 1fr 1fr}
.grid-4{grid-template-columns:1fr 1fr 1fr 1fr}

/* â”€â”€â”€ STAT â”€â”€â”€ */
.stat{display:flex;flex-direction:column;gap:4px}
.stat-label{font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px}
.stat-value{font-size:22px;font-weight:700}
.stat-sub{font-size:12px;color:var(--text-dim)}

/* â”€â”€â”€ MODALS â”€â”€â”€ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:3000}
.modal-overlay.show{display:flex}
.modal{background:var(--bg-modal);border:1px solid var(--border);border-radius:12px;width:90%;max-width:700px;max-height:85vh;overflow-y:auto;padding:24px}
.modal-title{font-size:18px;font-weight:700;margin-bottom:16px;display:flex;align-items:center;justify-content:space-between}
.modal-close{cursor:pointer;font-size:20px;color:var(--text-muted);padding:4px 8px}
.modal-close:hover{color:var(--text)}

/* â”€â”€â”€ SPECIFIC â”€â”€â”€ */
.driver-card{display:flex;align-items:center;gap:14px;padding:12px;border-radius:8px;background:rgba(255,255,255,.02);border:1px solid var(--border);margin-bottom:8px;cursor:pointer;transition:all .15s}
.driver-card:hover{background:var(--accent-glow);border-color:var(--accent)}
.driver-avatar{width:42px;height:42px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:16px}
.driver-info{flex:1}
.driver-name{font-weight:600;font-size:14px}
.driver-meta{font-size:11px;color:var(--text-dim);margin-top:2px}
.driver-rating{font-size:20px;font-weight:700}

.calendar-race{display:flex;align-items:center;gap:12px;padding:10px 14px;border-radius:8px;border:1px solid var(--border);margin-bottom:6px;transition:all .15s}
.calendar-race:hover{background:var(--bg-card-hover)}
.calendar-race.current{border-color:var(--accent);background:var(--accent-glow)}
.calendar-race.completed{opacity:.6}
.calendar-race .round{font-size:11px;color:var(--text-muted);width:28px}
.calendar-race .flag{font-size:22px;width:32px}
.calendar-race .name{flex:1;font-size:13px}
.calendar-race .result{font-size:12px;font-weight:600}

.standings-row{display:flex;align-items:center;gap:12px;padding:8px 12px;border-radius:6px;border-bottom:1px solid rgba(30,41,59,.3)}
.standings-row:hover{background:rgba(255,255,255,.02)}
.standings-pos{width:28px;font-weight:700;font-size:15px;text-align:center}
.standings-name{flex:1;font-size:13px}
.standings-pts{font-weight:700;font-size:14px;color:var(--accent)}

.weekend-phase{text-align:center;padding:20px;border-radius:8px;border:1px solid var(--border);cursor:pointer;transition:all .15s}
.weekend-phase:hover{border-color:var(--accent);background:var(--accent-glow)}
.weekend-phase.done{opacity:.5;border-color:var(--green);cursor:default}
.weekend-phase.active{border-color:var(--accent);background:var(--accent-glow);box-shadow:0 0 20px var(--accent-glow)}
.weekend-phase .phase-icon{font-size:28px;margin-bottom:6px}
.weekend-phase .phase-name{font-size:13px;font-weight:600}
.weekend-phase .phase-sub{font-size:11px;color:var(--text-dim);margin-top:4px}

.upgrade-item{display:flex;align-items:center;gap:14px;padding:12px;border:1px solid var(--border);border-radius:8px;margin-bottom:8px;transition:all .15s}
.upgrade-item:hover{background:var(--bg-card-hover)}
.upgrade-item .upgrade-icon{font-size:24px;width:40px;text-align:center}
.upgrade-item .upgrade-info{flex:1}
.upgrade-item .upgrade-name{font-weight:600;font-size:13px}
.upgrade-item .upgrade-desc{font-size:11px;color:var(--text-dim);margin-top:2px}
.upgrade-item .upgrade-cost{font-weight:600;font-size:13px;color:var(--yellow)}

/* â”€â”€â”€ INTRO SCREEN â”€â”€â”€ */
#intro-screen{position:fixed;inset:0;background:linear-gradient(135deg,#0a0e17 0%,#111827 50%,#0d1320 100%);z-index:2000;display:flex;align-items:center;justify-content:center;flex-direction:column}
#intro-screen .title{font-size:42px;font-weight:800;letter-spacing:3px;margin-bottom:8px}
#intro-screen .title span{color:var(--accent)}
#intro-screen .subtitle{font-size:15px;color:var(--text-dim);margin-bottom:40px}
#intro-screen .start-options{display:flex;flex-direction:column;gap:12px;width:350px}
#intro-screen .start-btn{padding:16px 24px;border:1px solid var(--border);background:var(--bg-card);color:var(--text);border-radius:10px;cursor:pointer;text-align:left;transition:all .2s}
#intro-screen .start-btn:hover{border-color:var(--accent);background:var(--accent-glow);transform:translateX(4px)}
#intro-screen .start-btn .s-title{font-size:15px;font-weight:600;margin-bottom:4px}
#intro-screen .start-btn .s-desc{font-size:12px;color:var(--text-dim)}
.name-input{background:var(--bg-card);border:1px solid var(--border);border-radius:8px;padding:12px 16px;color:var(--text);font-size:14px;width:100%;margin-bottom:16px;outline:none}
.name-input:focus{border-color:var(--accent)}
select.styled{background:var(--bg-card);border:1px solid var(--border);border-radius:6px;padding:8px 12px;color:var(--text);font-size:13px;outline:none;cursor:pointer}
select.styled:focus{border-color:var(--accent)}

/* â”€â”€â”€ ANIMATIONS â”€â”€â”€ */
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.fade-in{animation:fadeIn .3s ease}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
.pulse{animation:pulse 2s infinite}
@keyframes slideRight{from{transform:translateX(-20px);opacity:0}to{transform:translateX(0);opacity:1}}

/* â”€â”€â”€ NOTIFICATION â”€â”€â”€ */
#notification{position:fixed;top:60px;right:20px;background:var(--bg-card);border:1px solid var(--accent);border-radius:8px;padding:12px 18px;font-size:13px;z-index:4000;transform:translateX(400px);transition:transform .3s;max-width:350px}
#notification.show{transform:translateX(0)}
#notification .notif-title{font-weight:600;color:var(--accent);margin-bottom:4px}

/* â”€â”€â”€ RACE RESULT â”€â”€â”€ */
.race-result-grid{display:grid;grid-template-columns:40px 1fr 80px 60px;gap:8px;align-items:center;font-size:13px}
.race-result-grid .pos{font-weight:700;font-size:16px}
.medal-1{color:var(--gold)}
.medal-2{color:var(--silver)}
.medal-3{color:var(--bronze)}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• INTRO SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="intro-screen">
  <div class="title">MOTORSPORT <span>MANAGER</span></div>
  <div class="subtitle">Build your racing dynasty from Formula 4 to Formula 1</div>
  <div class="start-options">
    <div class="start-btn" onclick="showNewCareer()">
      <div class="s-title">ğŸ Neue Karriere</div>
      <div class="s-desc">Starte als kleines F4-Team und arbeite dich nach oben</div>
    </div>
    <div class="start-btn" id="continue-btn" style="display:none" onclick="loadCareer()">
      <div class="s-title">ğŸ“‚ Karriere fortsetzen</div>
      <div class="s-desc" id="continue-desc"></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• NEW CAREER MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="modal-new-career">
  <div class="modal" style="max-width:500px">
    <div class="modal-title">Neue Karriere starten</div>
    <div style="margin-bottom:14px">
      <label style="font-size:12px;color:var(--text-dim);display:block;margin-bottom:6px">Teamname</label>
      <input class="name-input" id="input-team-name" placeholder="z.B. Apex Racing" value="Apex Racing">
    </div>
    <div style="margin-bottom:14px">
      <label style="font-size:12px;color:var(--text-dim);display:block;margin-bottom:6px">Dein Name (Teamchef)</label>
      <input class="name-input" id="input-manager-name" placeholder="z.B. Max MÃ¼ller" value="">
    </div>
    <div style="margin-bottom:14px">
      <label style="font-size:12px;color:var(--text-dim);display:block;margin-bottom:6px">Startserie</label>
      <select class="styled" id="input-series" style="width:100%">
        <option value="f4">Formula 4 â€” Einstieg (â‚¬500k Budget)</option>
        <option value="f3">Formula 3 â€” Fortgeschritten (â‚¬2M Budget)</option>
        <option value="gt3">GT3 â€” Prototypen (â‚¬5M Budget)</option>
      </select>
    </div>
    <div style="margin-bottom:14px">
      <label style="font-size:12px;color:var(--text-dim);display:block;margin-bottom:6px">Schwierigkeit</label>
      <select class="styled" id="input-difficulty" style="width:100%">
        <option value="easy">Leicht â€” Mehr Budget, schwÃ¤chere KI</option>
        <option value="normal" selected>Normal â€” Ausgewogene Challenge</option>
        <option value="hard">Schwer â€” Knappes Budget, starke KI</option>
      </select>
    </div>
    <div style="display:flex;gap:10px;margin-top:20px">
      <button class="btn btn-primary" style="flex:1" onclick="startNewCareer()">ğŸ Karriere starten</button>
      <button class="btn btn-secondary" onclick="closeModal('modal-new-career')">Abbrechen</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MAIN APP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="app" style="display:none">
  <!-- TOP BAR -->
  <div id="topbar">
    <div class="logo">MOTORSPORT <span>MANAGER</span></div>
    <div class="info">
      <div>ğŸ’° Budget: <span class="val" id="top-budget">â‚¬0</span></div>
      <div>ğŸ“… <span class="val" id="top-season">Saison 1</span></div>
      <div>ğŸ† Serie: <span class="val" id="top-series">F4</span></div>
      <div>ğŸ“Š Ruf: <span class="val" id="top-reputation">0</span></div>
    </div>
  </div>

  <div id="main">
    <!-- SIDEBAR -->
    <div id="sidebar">
      <div class="nav-section">Saison</div>
      <div class="nav-item active" onclick="navigate('dashboard')" data-nav="dashboard">
        <span class="icon">ğŸ“Š</span> Dashboard
      </div>
      <div class="nav-item" onclick="navigate('calendar')" data-nav="calendar">
        <span class="icon">ğŸ“…</span> Kalender
      </div>
      <div class="nav-item" onclick="navigate('standings')" data-nav="standings">
        <span class="icon">ğŸ†</span> Meisterschaft
      </div>
      <div class="nav-item" onclick="navigate('weekend')" data-nav="weekend">
        <span class="icon">ğŸ</span> Rennwochenende
      </div>
      <div class="nav-section">Team</div>
      <div class="nav-item" onclick="navigate('car')" data-nav="car">
        <span class="icon">ğŸï¸</span> Fahrzeug
      </div>
      <div class="nav-item" onclick="navigate('drivers')" data-nav="drivers">
        <span class="icon">ğŸ‘¤</span> Fahrer
      </div>
      <div class="nav-item" onclick="navigate('staff')" data-nav="staff">
        <span class="icon">ğŸ‘¥</span> Personal
      </div>
      <div class="nav-section">Management</div>
      <div class="nav-item" onclick="navigate('development')" data-nav="development">
        <span class="icon">ğŸ”§</span> Entwicklung
      </div>
      <div class="nav-item" onclick="navigate('finances')" data-nav="finances">
        <span class="icon">ğŸ’°</span> Finanzen
      </div>
      <div class="nav-item" onclick="navigate('transfers')" data-nav="transfers">
        <span class="icon">ğŸ”„</span> Transfers
      </div>
      <div style="flex:1"></div>
      <div class="nav-item" onclick="saveCareer()" style="border-top:1px solid var(--border)">
        <span class="icon">ğŸ’¾</span> Speichern
      </div>
    </div>

    <!-- CONTENT AREA -->
    <div id="content"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• NOTIFICATION â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="notification">
  <div class="notif-title" id="notif-title"></div>
  <div id="notif-text"></div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MOTORSPORT MANAGER â€” Full Career Simulation
//  Integration: RaceModuleV1.html via localStorage
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€â”€ HELPERS â”€â”€â”€
function gaussianRandom() {
  let u = 0, v = 0;
  while (u === 0) u = Math.random();
  while (v === 0) v = Math.random();
  return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
}

function applySkillNoise(optimal, skill, maxNoise, maxBias = 0) {
  const sf = Math.min(99, Math.max(0, skill)) / 99;
  const sigma = maxNoise * (1 - sf);
  const noise = gaussianRandom() * sigma;
  const bias = maxBias * Math.pow(1 - sf, 2);
  return optimal + noise + bias;
}

function clamp(v, lo, hi) { return Math.max(lo, Math.min(hi, v)); }
function randInt(lo, hi) { return Math.floor(Math.random() * (hi - lo + 1)) + lo; }
function randFloat(lo, hi) { return Math.random() * (hi - lo) + lo; }
function pickRandom(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
function formatMoney(v) {
  if (v >= 1e6) return 'â‚¬' + (v / 1e6).toFixed(1) + 'M';
  if (v >= 1e3) return 'â‚¬' + (v / 1e3).toFixed(0) + 'k';
  return 'â‚¬' + v;
}
function skillClass(v) {
  if (v >= 85) return 'skill-elite';
  if (v >= 60) return 'skill-high';
  if (v >= 35) return 'skill-mid';
  return 'skill-low';
}

// â”€â”€â”€ DATA DEFINITIONS â”€â”€â”€
const SERIES_DATA = {
  f4: {
    name: 'Formula 4', short: 'F4', icon: 'ğŸï¸',
    budget: 500000, prizePool: [100000, 60000, 40000, 25000, 15000, 10000, 8000, 6000, 5000, 4000],
    sponsorRange: [50000, 200000],
    carDefaults: { power: 120000, mass: 570, tireGrip: 1.15, brakeForce: 8000, cLWing: 0.4, cLDiffuser: 0.3, cDBody: 0.55, cDWing: 0.08, frontalArea: 1.4 },
    gridSize: 16, driversPerTeam: 1,
    skillRange: [25, 65], staffSkillRange: [20, 55],
    upgradesAvailable: ['engine_basic', 'aero_basic', 'tires_basic'],
    pitStopBase: 0, hasPitStops: false,
    promotionPos: 3, relegationAt: null,
    nextSeries: 'f3',
    circuits: [
      { name: 'Oschersleben', country: 'ğŸ‡©ğŸ‡ª', laps: 18, lengthKm: 3.7 },
      { name: 'Spa-Francorchamps', country: 'ğŸ‡§ğŸ‡ª', laps: 12, lengthKm: 7.0 },
      { name: 'Mugello', country: 'ğŸ‡®ğŸ‡¹', laps: 16, lengthKm: 5.2 },
      { name: 'Hungaroring', country: 'ğŸ‡­ğŸ‡º', laps: 20, lengthKm: 4.4 },
      { name: 'Paul Ricard', country: 'ğŸ‡«ğŸ‡·', laps: 15, lengthKm: 5.8 },
      { name: 'Silverstone', country: 'ğŸ‡¬ğŸ‡§', laps: 17, lengthKm: 5.9 },
      { name: 'Red Bull Ring', country: 'ğŸ‡¦ğŸ‡¹', laps: 22, lengthKm: 4.3 },
      { name: 'Hockenheim', country: 'ğŸ‡©ğŸ‡ª', laps: 18, lengthKm: 4.6 },
    ]
  },
  f3: {
    name: 'Formula 3', short: 'F3', icon: 'ğŸï¸',
    budget: 2000000, prizePool: [400000, 250000, 150000, 100000, 70000, 50000, 40000, 30000, 20000, 15000],
    sponsorRange: [200000, 800000],
    carDefaults: { power: 280000, mass: 680, tireGrip: 1.30, brakeForce: 16000, cLWing: 0.8, cLDiffuser: 0.7, cDBody: 0.60, cDWing: 0.12, frontalArea: 1.5 },
    gridSize: 20, driversPerTeam: 2,
    skillRange: [40, 78], staffSkillRange: [35, 70],
    upgradesAvailable: ['engine_mid', 'aero_mid', 'tires_mid', 'suspension_basic'],
    pitStopBase: 12, hasPitStops: true,
    promotionPos: 3, nextSeries: 'f2',
    circuits: [
      { name: 'Barcelona', country: 'ğŸ‡ªğŸ‡¸', laps: 18, lengthKm: 4.7 },
      { name: 'Imola', country: 'ğŸ‡®ğŸ‡¹', laps: 20, lengthKm: 4.9 },
      { name: 'Spa-Francorchamps', country: 'ğŸ‡§ğŸ‡ª', laps: 12, lengthKm: 7.0 },
      { name: 'Zandvoort', country: 'ğŸ‡³ğŸ‡±', laps: 24, lengthKm: 4.3 },
      { name: 'Monza', country: 'ğŸ‡®ğŸ‡¹', laps: 16, lengthKm: 5.8 },
      { name: 'Silverstone', country: 'ğŸ‡¬ğŸ‡§', laps: 17, lengthKm: 5.9 },
      { name: 'Hungaroring', country: 'ğŸ‡­ğŸ‡º', laps: 22, lengthKm: 4.4 },
      { name: 'Abu Dhabi', country: 'ğŸ‡¦ğŸ‡ª', laps: 20, lengthKm: 5.3 },
      { name: 'Jeddah', country: 'ğŸ‡¸ğŸ‡¦', laps: 20, lengthKm: 6.2 },
    ]
  },
  f2: {
    name: 'Formula 2', short: 'F2', icon: 'ğŸï¸',
    budget: 5000000, prizePool: [800000, 500000, 300000, 200000, 150000, 100000, 80000, 60000, 50000, 40000],
    sponsorRange: [500000, 2000000],
    carDefaults: { power: 470000, mass: 755, tireGrip: 1.42, brakeForce: 26000, cLWing: 1.2, cLDiffuser: 1.3, cDBody: 0.65, cDWing: 0.15, frontalArea: 1.6 },
    gridSize: 22, driversPerTeam: 2,
    skillRange: [55, 88], staffSkillRange: [50, 80],
    upgradesAvailable: ['engine_adv', 'aero_adv', 'tires_adv', 'suspension_mid', 'telemetry_basic'],
    pitStopBase: 8, hasPitStops: true,
    promotionPos: 3, nextSeries: 'gt3',
    circuits: [
      { name: 'Bahrain', country: 'ğŸ‡§ğŸ‡­', laps: 23, lengthKm: 5.4 },
      { name: 'Jeddah', country: 'ğŸ‡¸ğŸ‡¦', laps: 20, lengthKm: 6.2 },
      { name: 'Melbourne', country: 'ğŸ‡¦ğŸ‡º', laps: 22, lengthKm: 5.3 },
      { name: 'Imola', country: 'ğŸ‡®ğŸ‡¹', laps: 22, lengthKm: 4.9 },
      { name: 'Monaco', country: 'ğŸ‡²ğŸ‡¨', laps: 30, lengthKm: 3.3 },
      { name: 'Barcelona', country: 'ğŸ‡ªğŸ‡¸', laps: 22, lengthKm: 4.7 },
      { name: 'Spielberg', country: 'ğŸ‡¦ğŸ‡¹', laps: 24, lengthKm: 4.3 },
      { name: 'Silverstone', country: 'ğŸ‡¬ğŸ‡§', laps: 20, lengthKm: 5.9 },
      { name: 'Spa', country: 'ğŸ‡§ğŸ‡ª', laps: 15, lengthKm: 7.0 },
      { name: 'Monza', country: 'ğŸ‡®ğŸ‡¹', laps: 20, lengthKm: 5.8 },
      { name: 'Abu Dhabi', country: 'ğŸ‡¦ğŸ‡ª', laps: 23, lengthKm: 5.3 },
    ]
  },
  gt3: {
    name: 'GT3 Championship', short: 'GT3', icon: 'ğŸï¸',
    budget: 8000000, prizePool: [1200000, 800000, 500000, 350000, 250000, 180000, 130000, 100000, 80000, 60000],
    sponsorRange: [1000000, 4000000],
    carDefaults: { power: 410000, mass: 1300, tireGrip: 1.35, brakeForce: 30000, cLWing: 0.9, cLDiffuser: 1.0, cDBody: 0.58, cDWing: 0.10, frontalArea: 2.0 },
    gridSize: 24, driversPerTeam: 2,
    skillRange: [50, 85], staffSkillRange: [45, 78],
    upgradesAvailable: ['engine_adv', 'aero_adv', 'tires_adv', 'suspension_mid', 'telemetry_mid', 'pit_crew'],
    pitStopBase: 10, hasPitStops: true,
    promotionPos: 2, nextSeries: 'f1',
    circuits: [
      { name: 'NÃ¼rburgring', country: 'ğŸ‡©ğŸ‡ª', laps: 20, lengthKm: 5.1 },
      { name: 'Brands Hatch', country: 'ğŸ‡¬ğŸ‡§', laps: 28, lengthKm: 3.9 },
      { name: 'Misano', country: 'ğŸ‡®ğŸ‡¹', laps: 24, lengthKm: 4.2 },
      { name: 'Spa-Francorchamps', country: 'ğŸ‡§ğŸ‡ª', laps: 14, lengthKm: 7.0 },
      { name: 'Bathurst', country: 'ğŸ‡¦ğŸ‡º', laps: 16, lengthKm: 6.2 },
      { name: 'Suzuka', country: 'ğŸ‡¯ğŸ‡µ', laps: 20, lengthKm: 5.8 },
      { name: 'Laguna Seca', country: 'ğŸ‡ºğŸ‡¸', laps: 26, lengthKm: 3.6 },
      { name: 'Zandvoort', country: 'ğŸ‡³ğŸ‡±', laps: 24, lengthKm: 4.3 },
      { name: 'Monza', country: 'ğŸ‡®ğŸ‡¹', laps: 18, lengthKm: 5.8 },
      { name: 'Kyalami', country: 'ğŸ‡¿ğŸ‡¦', laps: 22, lengthKm: 4.5 },
    ]
  },
  f1: {
    name: 'Formula 1', short: 'F1', icon: 'ğŸ†',
    budget: 145000000, prizePool: [30000000, 22000000, 16000000, 12000000, 10000000, 8000000, 6000000, 5000000, 4000000, 3000000],
    sponsorRange: [20000000, 80000000],
    carDefaults: { power: 760000, mass: 798, tireGrip: 1.50, brakeForce: 35000, cLWing: 1.575, cLDiffuser: 1.925, cDBody: 0.700, cDWing: 0.200, frontalArea: 1.80 },
    gridSize: 20, driversPerTeam: 2,
    skillRange: [70, 99], staffSkillRange: [65, 95],
    upgradesAvailable: ['engine_elite', 'aero_elite', 'tires_elite', 'suspension_adv', 'telemetry_adv', 'pit_crew_adv', 'wind_tunnel', 'simulator'],
    pitStopBase: 2.5, hasPitStops: true,
    promotionPos: null, nextSeries: null,
    circuits: [
      { name: 'Bahrain', country: 'ğŸ‡§ğŸ‡­', laps: 57, lengthKm: 5.4 },
      { name: 'Jeddah', country: 'ğŸ‡¸ğŸ‡¦', laps: 50, lengthKm: 6.2 },
      { name: 'Melbourne', country: 'ğŸ‡¦ğŸ‡º', laps: 58, lengthKm: 5.3 },
      { name: 'Suzuka', country: 'ğŸ‡¯ğŸ‡µ', laps: 53, lengthKm: 5.8 },
      { name: 'Shanghai', country: 'ğŸ‡¨ğŸ‡³', laps: 56, lengthKm: 5.5 },
      { name: 'Miami', country: 'ğŸ‡ºğŸ‡¸', laps: 57, lengthKm: 5.4 },
      { name: 'Imola', country: 'ğŸ‡®ğŸ‡¹', laps: 63, lengthKm: 4.9 },
      { name: 'Monaco', country: 'ğŸ‡²ğŸ‡¨', laps: 78, lengthKm: 3.3 },
      { name: 'Barcelona', country: 'ğŸ‡ªğŸ‡¸', laps: 66, lengthKm: 4.7 },
      { name: 'Montreal', country: 'ğŸ‡¨ğŸ‡¦', laps: 70, lengthKm: 4.4 },
      { name: 'Spielberg', country: 'ğŸ‡¦ğŸ‡¹', laps: 71, lengthKm: 4.3 },
      { name: 'Silverstone', country: 'ğŸ‡¬ğŸ‡§', laps: 52, lengthKm: 5.9 },
      { name: 'Budapest', country: 'ğŸ‡­ğŸ‡º', laps: 70, lengthKm: 4.4 },
      { name: 'Spa', country: 'ğŸ‡§ğŸ‡ª', laps: 44, lengthKm: 7.0 },
      { name: 'Zandvoort', country: 'ğŸ‡³ğŸ‡±', laps: 72, lengthKm: 4.3 },
      { name: 'Monza', country: 'ğŸ‡®ğŸ‡¹', laps: 53, lengthKm: 5.8 },
      { name: 'Singapore', country: 'ğŸ‡¸ğŸ‡¬', laps: 62, lengthKm: 5.1 },
      { name: 'COTA', country: 'ğŸ‡ºğŸ‡¸', laps: 56, lengthKm: 5.5 },
      { name: 'Mexico City', country: 'ğŸ‡²ğŸ‡½', laps: 71, lengthKm: 4.3 },
      { name: 'SÃ£o Paulo', country: 'ğŸ‡§ğŸ‡·', laps: 71, lengthKm: 4.3 },
      { name: 'Las Vegas', country: 'ğŸ‡ºğŸ‡¸', laps: 50, lengthKm: 6.1 },
      { name: 'Abu Dhabi', country: 'ğŸ‡¦ğŸ‡ª', laps: 58, lengthKm: 5.3 },
    ]
  }
};

const UPGRADE_CATALOG = {
  engine_basic:     { name: 'Motor-Tuning Stufe 1', icon: 'âš™ï¸', cost: 50000,  effect: { power: 0.02 }, desc: '+2% Leistung', category: 'power' },
  engine_mid:       { name: 'Motor-Tuning Stufe 2', icon: 'âš™ï¸', cost: 200000, effect: { power: 0.04 }, desc: '+4% Leistung', category: 'power' },
  engine_adv:       { name: 'Motor-Upgrade Pro',    icon: 'âš™ï¸', cost: 800000, effect: { power: 0.06 }, desc: '+6% Leistung', category: 'power' },
  engine_elite:     { name: 'Hybrid-Optimierung',   icon: 'âš¡', cost: 5000000, effect: { power: 0.08 }, desc: '+8% Leistung', category: 'power' },
  aero_basic:       { name: 'Aero-Kit Basis',       icon: 'ğŸŒŠ', cost: 40000,  effect: { aero: 0.03 }, desc: '+3% Downforce', category: 'aero' },
  aero_mid:         { name: 'Aero-Paket Stufe 2',   icon: 'ğŸŒŠ', cost: 250000, effect: { aero: 0.05 }, desc: '+5% Downforce', category: 'aero' },
  aero_adv:         { name: 'CFD-Optimierung',      icon: 'ğŸŒŠ', cost: 1200000,effect: { aero: 0.07 }, desc: '+7% Downforce', category: 'aero' },
  aero_elite:       { name: 'Windkanal-Upgrade',    icon: 'ğŸ’¨', cost: 8000000, effect: { aero: 0.10 }, desc: '+10% Downforce', category: 'aero' },
  tires_basic:      { name: 'Reifenmanagement',     icon: 'ğŸ›', cost: 30000,  effect: { wear: -0.05 }, desc: '-5% ReifenverschleiÃŸ', category: 'tires' },
  tires_mid:        { name: 'Reifenheizung',        icon: 'ğŸ›', cost: 150000, effect: { wear: -0.08 }, desc: '-8% VerschleiÃŸ', category: 'tires' },
  tires_adv:        { name: 'Reifen-Telemetrie',    icon: 'ğŸ›', cost: 600000, effect: { wear: -0.10 }, desc: '-10% VerschleiÃŸ', category: 'tires' },
  tires_elite:      { name: 'Reifen-Simulator',     icon: 'ğŸ›', cost: 4000000, effect: { wear: -0.14 }, desc: '-14% VerschleiÃŸ', category: 'tires' },
  suspension_basic: { name: 'Fahrwerk-Update',      icon: 'ğŸ”©', cost: 120000, effect: { grip: 0.02 }, desc: '+2% mech. Grip', category: 'chassis' },
  suspension_mid:   { name: 'Adaptive DÃ¤mpfer',     icon: 'ğŸ”©', cost: 500000, effect: { grip: 0.04 }, desc: '+4% mech. Grip', category: 'chassis' },
  suspension_adv:   { name: 'Aktive Federung',      icon: 'ğŸ”©', cost: 3000000, effect: { grip: 0.06 }, desc: '+6% mech. Grip', category: 'chassis' },
  telemetry_basic:  { name: 'Telemetrie-System',    icon: 'ğŸ“Š', cost: 100000, effect: { infra: 1 }, desc: '+1 Infrastruktur-Level', category: 'infra' },
  telemetry_mid:    { name: 'Live-Datenanalyse',    icon: 'ğŸ“Š', cost: 400000, effect: { infra: 1 }, desc: '+1 Infrastruktur-Level', category: 'infra' },
  telemetry_adv:    { name: 'KI-Strategie-Tool',    icon: 'ğŸ¤–', cost: 2000000, effect: { infra: 2 }, desc: '+2 Infrastruktur-Level', category: 'infra' },
  pit_crew:         { name: 'Boxencrew-Training',    icon: 'ğŸ—ï¸', cost: 200000, effect: { pitSpeed: 0.10 }, desc: '+10% Stopp-Speed', category: 'pit' },
  pit_crew_adv:     { name: 'Pit-Automation',        icon: 'ğŸ—ï¸', cost: 1500000, effect: { pitSpeed: 0.15 }, desc: '+15% Stopp-Speed', category: 'pit' },
  wind_tunnel:      { name: 'Windkanal',             icon: 'ğŸ­', cost: 15000000, effect: { aero: 0.05, infra: 2 }, desc: '+5% Aero, +2 Infra', category: 'infra' },
  simulator:        { name: 'Fahrsimulator',         icon: 'ğŸ–¥ï¸', cost: 8000000, effect: { infra: 2, driverDev: 0.10 }, desc: '+2 Infra, +10% Fahrer-Entwicklung', category: 'infra' },
};

const FIRST_NAMES = ['Max','Luca','Noah','Leon','Finn','Elias','Ben','Paul','Luis','Felix','Tom','Nico','Carlos','Oscar','Pierre','Daniel','Alex','Oliver','George','Lewis','Lando','Charles','Sergio','Yuki','Kevin','Valtteri','Esteban','Logan','Mick','Antonio','Nyck','Callum','Theo','Jack','Frederik','Dino','Marcus','Stoffel','Robert','Kimi','Jenson','Sebastian','Fernando','Felipe','Kamui','Romain','Jev','Robin','Dennis','Lirim'];
const LAST_NAMES = ['MÃ¼ller','Verstappen','Hamilton','Leclerc','Norris','Piastri','Alonso','Sainz','Russell','Stroll','Albon','Gasly','Ocon','Tsunoda','Magnussen','Hulkenberg','Bottas','Zhou','Sargeant','De Vries','Schumacher','Giovinazzi','Ilott','Shwartzman','Lawson','Drugovich','Pourchaire','Vesti','Hauger','Martins','Bearman','OÊ¼Sullivan','Maloney','Crawford','Colapinto','Antonelli','Bortoleto','Hadjar','Verschoor','Doohan','Armstrong','Daruvala','Nannini','Beckmann','Correa','Aitken','Boschung','Fittipaldi','Vidales','Mini'];

// â”€â”€â”€ NAMES GENERATOR â”€â”€â”€
function generateDriverName() {
  return pickRandom(FIRST_NAMES) + ' ' + pickRandom(LAST_NAMES);
}
function generateSkills(range) {
  return {
    braking: randInt(range[0], range[1]),
    cornering: randInt(range[0], range[1]),
    accelerating: randInt(range[0], range[1]),
    tyre_mgmt: randInt(range[0], range[1]),
    fuel_mgmt: randInt(range[0], range[1]),
    consistency: randInt(range[0], range[1]),
    wet_pace: randInt(range[0], range[1]),
    racecraft: randInt(range[0], range[1]),
    mental: randInt(range[0], range[1]),
  };
}
function avgSkill(skills) {
  const vals = Object.values(skills);
  return Math.round(vals.reduce((a,b) => a+b, 0) / vals.length);
}
function generateDriver(skillRange, age) {
  const skills = generateSkills(skillRange);
  return {
    id: 'D' + Date.now() + Math.random().toString(36).substr(2,4),
    name: generateDriverName(),
    age: age || randInt(17, 34),
    nationality: pickRandom(['ğŸ‡©ğŸ‡ª','ğŸ‡¬ğŸ‡§','ğŸ‡«ğŸ‡·','ğŸ‡®ğŸ‡¹','ğŸ‡ªğŸ‡¸','ğŸ‡³ğŸ‡±','ğŸ‡¦ğŸ‡¹','ğŸ‡§ğŸ‡·','ğŸ‡¦ğŸ‡º','ğŸ‡¯ğŸ‡µ','ğŸ‡ºğŸ‡¸','ğŸ‡²ğŸ‡½','ğŸ‡¨ğŸ‡¦','ğŸ‡µğŸ‡±','ğŸ‡«ğŸ‡®','ğŸ‡©ğŸ‡°','ğŸ‡§ğŸ‡ª','ğŸ‡¨ğŸ‡­','ğŸ‡¸ğŸ‡ª','ğŸ‡³ğŸ‡´']),
    skills,
    potential: randInt(Math.max(avgSkill(skills), 50), 99),
    salary: Math.round((avgSkill(skills) * avgSkill(skills) * 50) + randInt(5000, 30000)),
    contract: randInt(1, 3),
    morale: randInt(60, 95),
    form: randInt(40, 100),
    experience: randInt(0, 200),
  };
}

function generateStaffMember(role, skillRange) {
  return {
    id: 'S' + Date.now() + Math.random().toString(36).substr(2,4),
    name: generateDriverName(),
    role,
    skill: randInt(skillRange[0], skillRange[1]),
    salary: randInt(20000, 150000) * (role === 'engineerChief' ? 3 : role === 'strategist' ? 2.5 : 1),
    contract: randInt(1, 3),
    morale: randInt(60, 95),
  };
}

const TEAM_COLORS = ['#e8002d','#0090ff','#00d2be','#ff8700','#006f62','#0072ea','#2293d1','#6692ff','#52e252','#b6babd',
                     '#c92d4b','#1e6fff','#00c9a7','#ffa600','#8b5cf6','#ec4899','#14b8a6','#f59e0b','#6366f1','#10b981',
                     '#ef4444','#3b82f6','#8b5cf6','#f97316'];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let G = null; // Global game state

function createNewGameState(teamName, managerName, seriesId, difficulty) {
  const series = SERIES_DATA[seriesId];
  const diffMult = { easy: 1.3, normal: 1.0, hard: 0.7 };
  const aiSkillMod = { easy: -10, normal: 0, hard: 8 };

  // Create player team
  const playerDrivers = [];
  for (let i = 0; i < series.driversPerTeam; i++) {
    const d = generateDriver(series.skillRange, randInt(18, 24));
    d.salary = Math.round(d.salary * 0.8);
    playerDrivers.push(d);
  }

  const staff = {
    engineer: generateStaffMember('engineer', series.staffSkillRange),
    strategist: generateStaffMember('strategist', series.staffSkillRange),
    mechanics: [
      generateStaffMember('mechanic', [series.staffSkillRange[0]-5, series.staffSkillRange[1]-5]),
      generateStaffMember('mechanic', [series.staffSkillRange[0]-5, series.staffSkillRange[1]-5]),
    ]
  };

  // Generate AI teams
  const numAITeams = Math.ceil((series.gridSize - series.driversPerTeam) / Math.max(1, series.driversPerTeam));
  const aiTeams = [];
  for (let t = 0; t < numAITeams; t++) {
    const aiDrivers = [];
    for (let d = 0; d < series.driversPerTeam; d++) {
      const dr = generateDriver([series.skillRange[0] + aiSkillMod[difficulty], series.skillRange[1] + aiSkillMod[difficulty]]);
      aiDrivers.push(dr);
    }
    const aiStaff = {
      engineer: generateStaffMember('engineer', series.staffSkillRange),
      strategist: generateStaffMember('strategist', series.staffSkillRange),
    };
    aiTeams.push({
      id: 'AI' + t,
      name: pickRandom(['Trident','Prema','ART','Carlin','MP','DAMS','UNI','Hitech','Campos','Charouz','Van Amersfoort','Jenzer','BWT','Iron Lynx','WRT','Rowe','AF Corse','Walkenhorst','Garage 59','Haas Jr','Sauber Acad','Alpine Acad','RB Junior','Williams Acad']) + ' ' + pickRandom(['Racing','Motorsport','GP','Team','Performance','']),
      color: TEAM_COLORS[t % TEAM_COLORS.length],
      drivers: aiDrivers,
      staff: aiStaff,
      carPerformance: { power: 1.0 + randFloat(-0.03, 0.03), aero: 1.0 + randFloat(-0.03, 0.03), grip: 1.0 + randFloat(-0.02, 0.02), wear: 1.0 + randFloat(-0.03, 0.03) },
      budget: Math.round(series.budget * randFloat(0.8, 1.3)),
    });
  }

  // Calendar
  const calendar = series.circuits.map((c, i) => ({
    round: i + 1, ...c,
    weather: pickRandom(['sunny','sunny','sunny','cloudy','cloudy','light_rain']),
    completed: false, results: null,
  }));

  // Standings
  const allDriverIds = [...playerDrivers.map(d => d.id), ...aiTeams.flatMap(t => t.drivers.map(d => d.id))];
  const standings = {};
  allDriverIds.forEach(id => { standings[id] = 0; });

  return {
    version: 1,
    teamName,
    managerName,
    series: seriesId,
    season: 1,
    difficulty,
    budget: Math.round(series.budget * diffMult[difficulty]),
    reputation: 10,
    infrastructure: 1,
    drivers: playerDrivers,
    staff,
    car: { ...series.carDefaults, upgrades: [], performanceMult: { power: 1.0, aero: 1.0, grip: 1.0, wear: 1.0 } },
    aiTeams,
    calendar,
    currentRound: 0,
    standings,
    teamStandings: {},
    weekendState: null,
    history: [],
    transfers: { available: [], cooldown: 0 },
    finances: {
      income: [],
      expenses: [],
      sponsorDeals: [{ name: 'Startvertrag', amount: Math.round(series.sponsorRange[0] * diffMult[difficulty]), duration: 2 }],
    },
    totalRaces: 0,
    wins: 0,
    podiums: 0,
    championships: 0,
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NAVIGATION & RENDERING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentPage = 'dashboard';

function navigate(page) {
  currentPage = page;
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  const nav = document.querySelector(`[data-nav="${page}"]`);
  if (nav) nav.classList.add('active');
  renderPage();
}

function renderPage() {
  const c = document.getElementById('content');
  updateTopBar();
  switch (currentPage) {
    case 'dashboard': c.innerHTML = renderDashboard(); break;
    case 'calendar': c.innerHTML = renderCalendar(); break;
    case 'standings': c.innerHTML = renderStandings(); break;
    case 'weekend': c.innerHTML = renderWeekend(); break;
    case 'car': c.innerHTML = renderCar(); break;
    case 'drivers': c.innerHTML = renderDrivers(); break;
    case 'staff': c.innerHTML = renderStaff(); break;
    case 'development': c.innerHTML = renderDevelopment(); break;
    case 'finances': c.innerHTML = renderFinances(); break;
    case 'transfers': c.innerHTML = renderTransfers(); break;
    default: c.innerHTML = '<div class="card">Seite nicht gefunden</div>';
  }
}

function updateTopBar() {
  document.getElementById('top-budget').textContent = formatMoney(G.budget);
  document.getElementById('top-season').textContent = `Saison ${G.season}`;
  document.getElementById('top-series').textContent = SERIES_DATA[G.series].short;
  document.getElementById('top-reputation').textContent = G.reputation;
}

// â”€â”€â”€ NOTIFICATION SYSTEM â”€â”€â”€
let notifTimeout = null;
function notify(title, text, duration = 4000) {
  const el = document.getElementById('notification');
  document.getElementById('notif-title').textContent = title;
  document.getElementById('notif-text').textContent = text;
  el.classList.add('show');
  if (notifTimeout) clearTimeout(notifTimeout);
  notifTimeout = setTimeout(() => el.classList.remove('show'), duration);
}

// â”€â”€â”€ MODAL SYSTEM â”€â”€â”€
function openModal(id) { document.getElementById(id).classList.add('show'); }
function closeModal(id) { document.getElementById(id).classList.remove('show'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PAGE RENDERERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderDashboard() {
  const series = SERIES_DATA[G.series];
  const nextRace = G.calendar.find(r => !r.completed);
  const sortedStandings = getSortedStandings();
  const myPos = sortedStandings.findIndex(s => G.drivers.some(d => d.id === s.id)) + 1;
  const totalDriverSalary = G.drivers.reduce((s, d) => s + d.salary, 0);
  const totalStaffSalary = [G.staff.engineer, G.staff.strategist, ...G.staff.mechanics].reduce((s, st) => s + st.salary, 0);
  const sponsorIncome = G.finances.sponsorDeals.reduce((s, sp) => s + sp.amount, 0);

  return `<div class="fade-in">
    <h2 style="margin-bottom:20px;font-size:22px">${G.teamName} â€” ${series.name}</h2>
    <div class="grid grid-4" style="margin-bottom:20px">
      <div class="card"><div class="stat"><span class="stat-label">Budget</span><span class="stat-value" style="color:var(--green)">${formatMoney(G.budget)}</span><span class="stat-sub">pro Saison: ${formatMoney(sponsorIncome)}</span></div></div>
      <div class="card"><div class="stat"><span class="stat-label">Meisterschaft</span><span class="stat-value">#${myPos || 'â€”'}</span><span class="stat-sub">${G.drivers.reduce((s,d) => s + (G.standings[d.id]||0), 0)} Punkte</span></div></div>
      <div class="card"><div class="stat"><span class="stat-label">Saison ${G.season}</span><span class="stat-value">${G.calendar.filter(r=>r.completed).length}/${G.calendar.length}</span><span class="stat-sub">Rennen gefahren</span></div></div>
      <div class="card"><div class="stat"><span class="stat-label">Bilanz</span><span class="stat-value" style="color:var(--gold)">${G.wins}ğŸ† ${G.podiums}ğŸ¥ˆ</span><span class="stat-sub">${G.totalRaces} Rennen</span></div></div>
    </div>

    <div class="grid grid-2">
      <div class="card">
        <div class="card-header">NÃ¤chstes Rennen ${nextRace ? '' : '<span class="badge" style="background:var(--green);color:#000">Saison beendet</span>'}</div>
        ${nextRace ? `
          <div style="display:flex;align-items:center;gap:16px;margin-bottom:16px">
            <span style="font-size:40px">${nextRace.country}</span>
            <div>
              <div style="font-size:18px;font-weight:600">${nextRace.name}</div>
              <div style="font-size:12px;color:var(--text-dim)">Runde ${nextRace.round} Â· ${nextRace.laps} Runden Â· ${nextRace.lengthKm} km</div>
              <div style="font-size:12px;color:var(--text-dim);margin-top:4px">Wetter: ${nextRace.weather === 'sunny' ? 'â˜€ï¸ Sonnig' : nextRace.weather === 'cloudy' ? 'â›… BewÃ¶lkt' : 'ğŸŒ§ï¸ Regen'}</div>
            </div>
          </div>
          <button class="btn btn-primary" onclick="navigate('weekend')">ğŸ Zum Rennwochenende</button>
        ` : `<p style="color:var(--text-dim)">Die Saison ist beendet! ${myPos <= (series.promotionPos || 999) && series.nextSeries ? '<br><button class=\"btn btn-success\" style=\"margin-top:12px\" onclick=\"attemptPromotion()\">ğŸ† Aufstieg in die ' + SERIES_DATA[series.nextSeries].name + '!</button>' : '<br><button class=\"btn btn-primary\" style=\"margin-top:12px\" onclick=\"startNewSeason()\">ğŸ“… Neue Saison starten</button>'}</p>`}
      </div>

      <div class="card">
        <div class="card-header">Fahrer</div>
        ${G.drivers.map(d => `
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:10px">
            <div class="driver-avatar" style="background:${G.aiTeams.length > 0 ? TEAM_COLORS[0] : 'var(--accent)'}">${d.name.charAt(0)}</div>
            <div style="flex:1">
              <div style="font-weight:600;font-size:13px">${d.nationality} ${d.name}</div>
              <div style="font-size:11px;color:var(--text-dim)">Alter ${d.age} Â· Moral ${d.morale}%</div>
            </div>
            <span class="skill-badge ${skillClass(avgSkill(d.skills))}">${avgSkill(d.skills)}</span>
          </div>
        `).join('')}
      </div>
    </div>

    <div class="grid grid-2" style="margin-top:0">
      <div class="card">
        <div class="card-header">Top 5 Meisterschaft</div>
        ${sortedStandings.slice(0, 5).map((s, i) => `
          <div class="standings-row" style="${G.drivers.some(d=>d.id===s.id) ? 'background:var(--accent-glow)' : ''}">
            <div class="standings-pos ${i===0?'medal-1':i===1?'medal-2':i===2?'medal-3':''}">${i+1}</div>
            <div class="standings-name">${findDriverName(s.id)}</div>
            <div class="standings-pts">${s.pts}</div>
          </div>
        `).join('')}
      </div>

      <div class="card">
        <div class="card-header">Finanzen (monatlich)</div>
        <div style="display:flex;flex-direction:column;gap:8px">
          <div style="display:flex;justify-content:space-between"><span style="color:var(--text-dim)">Sponsoren</span><span style="color:var(--green)">+${formatMoney(Math.round(sponsorIncome / 12))}</span></div>
          <div style="display:flex;justify-content:space-between"><span style="color:var(--text-dim)">Fahrer-GehÃ¤lter</span><span style="color:var(--red)">-${formatMoney(Math.round(totalDriverSalary / 12))}</span></div>
          <div style="display:flex;justify-content:space-between"><span style="color:var(--text-dim)">Personal-GehÃ¤lter</span><span style="color:var(--red)">-${formatMoney(Math.round(totalStaffSalary / 12))}</span></div>
          <hr style="border-color:var(--border)">
          <div style="display:flex;justify-content:space-between;font-weight:600"><span>Netto</span><span style="color:${(sponsorIncome - totalDriverSalary - totalStaffSalary) > 0 ? 'var(--green)' : 'var(--red)'}">${formatMoney(Math.round((sponsorIncome - totalDriverSalary - totalStaffSalary) / 12))}/Monat</span></div>
        </div>
      </div>
    </div>
  </div>`;
}

function renderCalendar() {
  return `<div class="fade-in">
    <h2 style="margin-bottom:20px">ğŸ“… Saison ${G.season} Kalender â€” ${SERIES_DATA[G.series].name}</h2>
    <div class="card">
      ${G.calendar.map(r => `
        <div class="calendar-race ${r.completed ? 'completed' : ''} ${!r.completed && r.round === (G.currentRound + 1) ? 'current' : ''}" ${!r.completed && r.round === (G.currentRound + 1) ? 'onclick="navigate(\'weekend\')"' : ''} style="${!r.completed && r.round === (G.currentRound + 1) ? 'cursor:pointer' : ''}">
          <div class="round">R${r.round}</div>
          <div class="flag">${r.country}</div>
          <div class="name">
            <div style="font-weight:600">${r.name}</div>
            <div style="font-size:11px;color:var(--text-dim)">${r.laps} Runden Â· ${r.lengthKm} km Â· ${r.weather === 'sunny' ? 'â˜€ï¸' : r.weather === 'cloudy' ? 'â›…' : 'ğŸŒ§ï¸'}</div>
          </div>
          <div class="result">${r.results ? getPlayerResult(r.results) : (r.round === G.currentRound + 1 ? '<span style="color:var(--accent)" class="pulse">NEXT</span>' : '')}</div>
        </div>
      `).join('')}
    </div>
  </div>`;
}

function renderStandings() {
  const sorted = getSortedStandings();
  const teamStandings = getTeamStandings();
  
  return `<div class="fade-in">
    <h2 style="margin-bottom:20px">ğŸ† Meisterschafts-Wertung â€” ${SERIES_DATA[G.series].name}</h2>
    <div class="tabs">
      <div class="tab active" onclick="this.parentNode.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));this.classList.add('active');document.getElementById('standings-drivers').style.display='block';document.getElementById('standings-teams').style.display='none'">Fahrerwertung</div>
      <div class="tab" onclick="this.parentNode.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));this.classList.add('active');document.getElementById('standings-drivers').style.display='none';document.getElementById('standings-teams').style.display='block'">Teamwertung</div>
    </div>
    <div id="standings-drivers" class="card">
      <table>
        <thead><tr><th>#</th><th>Fahrer</th><th>Team</th><th>Punkte</th><th>Siege</th></tr></thead>
        <tbody>
          ${sorted.map((s, i) => {
            const isPlayer = G.drivers.some(d => d.id === s.id);
            return `<tr style="${isPlayer ? 'background:var(--accent-glow)' : ''}">
              <td style="font-weight:700;${i===0?'color:var(--gold)':i===1?'color:var(--silver)':i===2?'color:var(--bronze)':''}">${i + 1}</td>
              <td style="font-weight:${isPlayer?'700':'400'}">${findDriverName(s.id)}</td>
              <td style="color:var(--text-dim);font-size:12px">${findDriverTeam(s.id)}</td>
              <td style="font-weight:700;color:var(--accent)">${s.pts}</td>
              <td>${s.wins || 0}</td>
            </tr>`;
          }).join('')}
        </tbody>
      </table>
    </div>
    <div id="standings-teams" class="card" style="display:none">
      ${teamStandings.map((t, i) => `
        <div class="standings-row" style="${t.isPlayer ? 'background:var(--accent-glow)' : ''}">
          <div class="standings-pos ${i===0?'medal-1':i===1?'medal-2':i===2?'medal-3':''}">${i+1}</div>
          <div class="standings-name" style="font-weight:${t.isPlayer?'700':'400'}">${t.name}</div>
          <div class="standings-pts">${t.pts}</div>
        </div>
      `).join('')}
    </div>
  </div>`;
}

function renderWeekend() {
  const nextRace = G.calendar.find(r => !r.completed);
  if (!nextRace) return '<div class="card fade-in"><p>Alle Rennen der Saison sind abgeschlossen! Gehe zum Dashboard fÃ¼r die nÃ¤chste Saison.</p></div>';

  if (!G.weekendState) {
    G.weekendState = {
      round: nextRace.round,
      phase: 'pre', // pre, fp1, fp2, fp3, quali, race, finished
      fpResults: [],
      qualiResult: null,
      raceResult: null,
      setupAdjustments: 0,
    };
  }

  const ws = G.weekendState;
  const series = SERIES_DATA[G.series];

  return `<div class="fade-in">
    <h2 style="margin-bottom:4px">${nextRace.country} ${nextRace.name} â€” Runde ${nextRace.round}</h2>
    <p style="color:var(--text-dim);font-size:13px;margin-bottom:20px">${nextRace.laps} Runden Â· ${nextRace.lengthKm} km Â· ${nextRace.weather === 'sunny' ? 'â˜€ï¸ Sonnig' : nextRace.weather === 'cloudy' ? 'â›… BewÃ¶lkt' : 'ğŸŒ§ï¸ Regen'}</p>

    <div class="grid grid-4" style="margin-bottom:20px">
      ${renderPhaseCard('fp', 'FP', 'ğŸ”§', 'Freies Training', ws.phase, ws.fpResults.length > 0)}
      ${renderPhaseCard('quali', 'QUALI', 'â±ï¸', 'Qualifying', ws.phase, ws.qualiResult !== null)}
      ${renderPhaseCard('race', 'RACE', 'ğŸ', 'Rennen', ws.phase, ws.raceResult !== null)}
      ${renderPhaseCard('finished', 'DONE', 'ğŸ†', 'Ergebnis', ws.phase, false)}
    </div>

    ${ws.phase === 'pre' ? `
      <div class="card">
        <div class="card-header">Vorbereitung</div>
        <p style="color:var(--text-dim);font-size:13px;margin-bottom:16px">WÃ¤hle deine Vorgehensweise fÃ¼r das Wochenende. Im Freien Training kannst du Setup-Daten sammeln.</p>
        <div class="grid grid-2">
          <div>
            <h4 style="margin-bottom:10px;font-size:14px">Deine Fahrer</h4>
            ${G.drivers.map(d => `<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;font-size:13px">
              <span class="skill-badge ${skillClass(avgSkill(d.skills))}">${avgSkill(d.skills)}</span>
              <span>${d.name}</span>
              <span style="color:var(--text-dim);font-size:11px">Form: ${d.form}%</span>
            </div>`).join('')}
          </div>
          <div>
            <h4 style="margin-bottom:10px;font-size:14px">Team-Info</h4>
            <div style="font-size:13px;color:var(--text-dim);line-height:1.8">
              Ingenieur: ${G.staff.engineer.name} (Skill ${G.staff.engineer.skill})<br>
              Strategist: ${G.staff.strategist.name} (Skill ${G.staff.strategist.skill})<br>
              Infrastruktur: Stufe ${G.infrastructure}/6<br>
              Auto-Performance: ${Math.round((G.car.performanceMult.power + G.car.performanceMult.aero + G.car.performanceMult.grip) / 3 * 100)}%
            </div>
          </div>
        </div>
        <button class="btn btn-primary" style="margin-top:16px" onclick="startFP()">ğŸ”§ Freies Training starten</button>
      </div>
    ` : ''}

    ${ws.phase === 'fp' ? `
      <div class="card">
        <div class="card-header">Freies Training â€” Ergebnisse</div>
        ${ws.fpResults.length > 0 ? `
          <table>
            <thead><tr><th>#</th><th>Fahrer</th><th>Zeit</th><th>Gap</th></tr></thead>
            <tbody>
              ${ws.fpResults.map((r, i) => `
                <tr style="${G.drivers.some(d=>d.id===r.id) ? 'background:var(--accent-glow)' : ''}">
                  <td style="font-weight:700">${i + 1}</td>
                  <td>${findDriverName(r.id)}</td>
                  <td style="font-family:monospace">${formatLapTime(r.time)}</td>
                  <td style="color:var(--text-dim);font-family:monospace">${i === 0 ? '' : '+' + (r.time - ws.fpResults[0].time).toFixed(3)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
          <div style="margin-top:16px;display:flex;gap:10px">
            <button class="btn btn-primary" onclick="startQuali()">â±ï¸ Zum Qualifying</button>
            <button class="btn btn-secondary" onclick="adjustSetup()">ğŸ”§ Setup anpassen (${3 - ws.setupAdjustments} Ã¼brig)</button>
          </div>
        ` : '<p style="color:var(--text-dim)">Training lÃ¤uft...</p>'}
      </div>
    ` : ''}

    ${ws.phase === 'quali' ? `
      <div class="card">
        <div class="card-header">Qualifying â€” Startaufstellung</div>
        ${ws.qualiResult ? `
          <table>
            <thead><tr><th>Pos</th><th>Fahrer</th><th>Zeit</th><th>Gap</th></tr></thead>
            <tbody>
              ${ws.qualiResult.map((r, i) => `
                <tr style="${G.drivers.some(d=>d.id===r.id) ? 'background:var(--accent-glow)' : ''}">
                  <td style="font-weight:700;${i===0?'color:var(--gold)':''}">${i + 1}</td>
                  <td>${findDriverName(r.id)}</td>
                  <td style="font-family:monospace">${formatLapTime(r.time)}</td>
                  <td style="color:var(--text-dim);font-family:monospace">${i === 0 ? 'POLE' : '+' + (r.time - ws.qualiResult[0].time).toFixed(3)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
          <button class="btn btn-primary" style="margin-top:16px" onclick="startRace()">ğŸ Rennen starten</button>
        ` : '<p style="color:var(--text-dim)">Qualifying lÃ¤uft...</p>'}
      </div>
    ` : ''}

    ${ws.phase === 'race_running' ? `
      <div class="card">
        <div class="card-header">ğŸ Rennen</div>
        <p style="color:var(--text-dim);margin-bottom:12px">WÃ¤hle, ob du das Rennen live in der 3D-Ansicht verfolgen oder schnell simulieren willst.</p>
        <div style="display:flex;gap:12px">
          <button class="btn btn-primary" onclick="launchRaceView()">ğŸï¸ Live im RaceModule ansehen</button>
          <button class="btn btn-secondary" onclick="simulateRace()">â© Schnell simulieren</button>
        </div>
      </div>
    ` : ''}

    ${ws.phase === 'finished' && ws.raceResult ? `
      <div class="card">
        <div class="card-header">ğŸ† Rennergebnis â€” ${nextRace.name}</div>
        <div class="race-result-grid" style="margin-bottom:16px">
          <div style="font-weight:600;color:var(--text-muted)">Pos</div>
          <div style="font-weight:600;color:var(--text-muted)">Fahrer</div>
          <div style="font-weight:600;color:var(--text-muted)">Zeit</div>
          <div style="font-weight:600;color:var(--text-muted)">Pkt</div>
          ${ws.raceResult.slice(0, 15).map((r, i) => `
            <div class="pos ${i===0?'medal-1':i===1?'medal-2':i===2?'medal-3':''}" style="${G.drivers.some(d=>d.id===r.id)?'color:var(--accent)':''}">${i+1}</div>
            <div style="font-weight:${G.drivers.some(d=>d.id===r.id)?'700':'400'}">${findDriverName(r.id)}</div>
            <div style="font-family:monospace;font-size:12px;color:var(--text-dim)">${i === 0 ? formatRaceTime(r.time) : '+' + (r.time - ws.raceResult[0].time).toFixed(1) + 's'}</div>
            <div style="font-weight:600;color:var(--accent)">${getPoints(i)}</div>
          `).join('')}
        </div>
        <button class="btn btn-primary" onclick="confirmRaceResult()">âœ“ Weiter</button>
      </div>
    ` : ''}
  </div>`;
}

function renderPhaseCard(phase, label, icon, desc, currentPhase, done) {
  const phases = ['pre','fp','quali','race','race_running','finished'];
  const phaseOrder = { pre: 0, fp: 1, quali: 2, race: 3, race_running: 3, finished: 4 };
  const pO = phaseOrder[phase] || 0;
  const cO = phaseOrder[currentPhase] || 0;
  const cls = done ? 'done' : (cO === pO ? 'active' : '');
  return `<div class="weekend-phase ${cls}">
    <div class="phase-icon">${done ? 'âœ…' : icon}</div>
    <div class="phase-name">${label}</div>
    <div class="phase-sub">${desc}</div>
  </div>`;
}

function renderCar() {
  const series = SERIES_DATA[G.series];
  const car = G.car;
  const perf = car.performanceMult;
  return `<div class="fade-in">
    <h2 style="margin-bottom:20px">ğŸï¸ Fahrzeug â€” ${series.name} Spec</h2>
    <div class="grid grid-2">
      <div class="card">
        <div class="card-header">Performance</div>
        ${renderPerformanceBar('Leistung', perf.power, 'cyan')}
        ${renderPerformanceBar('Aerodynamik', perf.aero, 'green')}
        ${renderPerformanceBar('Grip', perf.grip, 'yellow')}
        ${renderPerformanceBar('ReifenverschleiÃŸ', 2 - perf.wear, 'orange')}
        <div style="margin-top:12px;font-size:11px;color:var(--text-dim)">Gesamt: ${Math.round((perf.power + perf.aero + perf.grip + (2 - perf.wear)) / 4 * 100)}% Performance-Rating</div>
      </div>
      <div class="card">
        <div class="card-header">Spezifikationen</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:13px">
          <div><span style="color:var(--text-dim)">Leistung:</span> ${Math.round(car.power * perf.power / 1000)} kW</div>
          <div><span style="color:var(--text-dim)">Masse:</span> ${car.mass} kg</div>
          <div><span style="color:var(--text-dim)">Grip Âµ:</span> ${(car.tireGrip * perf.grip).toFixed(2)}</div>
          <div><span style="color:var(--text-dim)">Bremskraft:</span> ${Math.round(car.brakeForce/1000)} kN</div>
          <div><span style="color:var(--text-dim)">CL Wing:</span> ${(car.cLWing * perf.aero).toFixed(3)}</div>
          <div><span style="color:var(--text-dim)">CL Diffuser:</span> ${(car.cLDiffuser * perf.aero).toFixed(3)}</div>
          <div><span style="color:var(--text-dim)">CD Body:</span> ${car.cDBody.toFixed(3)}</div>
          <div><span style="color:var(--text-dim)">FrontalflÃ¤che:</span> ${car.frontalArea} mÂ²</div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-header">Installierte Upgrades</div>
      ${car.upgrades.length === 0 ? '<p style="color:var(--text-dim);font-size:13px">Noch keine Upgrades installiert. Gehe zu Entwicklung um Upgrades zu kaufen.</p>' : 
        car.upgrades.map(u => {
          const upg = UPGRADE_CATALOG[u];
          return `<div style="display:flex;align-items:center;gap:10px;padding:6px 0;font-size:13px;border-bottom:1px solid rgba(30,41,59,.3)">
            <span>${upg.icon}</span><span style="font-weight:600">${upg.name}</span><span style="color:var(--text-dim)">${upg.desc}</span>
          </div>`;
        }).join('')}
    </div>
  </div>`;
}

function renderPerformanceBar(label, value, color) {
  const pct = Math.round(Math.min(1.5, Math.max(0.5, value)) / 1.5 * 100);
  return `<div style="margin-bottom:10px">
    <div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px">
      <span>${label}</span><span style="font-weight:600">${Math.round(value * 100)}%</span>
    </div>
    <div class="bar-wrap bar-${color}"><div class="bar-fill" style="width:${pct}%"></div></div>
  </div>`;
}

function renderDrivers() {
  return `<div class="fade-in">
    <h2 style="margin-bottom:20px">ğŸ‘¤ Fahrer</h2>
    ${G.drivers.map((d, idx) => `
      <div class="card">
        <div class="card-header">
          <span>${d.nationality} ${d.name} <span style="color:var(--text-dim);font-size:12px;font-weight:400">Alter ${d.age} Â· Vertrag: ${d.contract} Saison(en)</span></span>
          <span class="skill-badge ${skillClass(avgSkill(d.skills))}" style="font-size:16px">${avgSkill(d.skills)} OVR</span>
        </div>
        <div class="grid grid-3" style="margin-bottom:12px">
          ${Object.entries(d.skills).map(([k, v]) => `
            <div style="display:flex;align-items:center;gap:8px;font-size:12px">
              <span style="color:var(--text-dim);width:90px">${skillLabel(k)}</span>
              <div class="bar-wrap" style="width:80px"><div class="bar-fill" style="width:${v}%;background:${v>=85?'var(--purple)':v>=60?'var(--green)':v>=35?'var(--yellow)':'var(--red)'}"></div></div>
              <span class="skill-badge ${skillClass(v)}" style="font-size:11px;padding:1px 6px">${v}</span>
            </div>
          `).join('')}
        </div>
        <div style="display:flex;gap:16px;font-size:12px;color:var(--text-dim)">
          <span>ğŸ’° Gehalt: ${formatMoney(d.salary)}/Saison</span>
          <span>ğŸ“Š Potential: ${d.potential}</span>
          <span>ğŸ¯ Form: ${d.form}%</span>
          <span>ğŸ˜ƒ Moral: ${d.morale}%</span>
          <span>â­ Erfahrung: ${d.experience}</span>
        </div>
      </div>
    `).join('')}
  </div>`;
}

function renderStaff() {
  const allStaff = [
    { ...G.staff.engineer, roleLabel: 'ğŸ”§ Renningenieur' },
    { ...G.staff.strategist, roleLabel: 'ğŸ“Š Strategist' },
    ...G.staff.mechanics.map((m, i) => ({ ...m, roleLabel: `ğŸ—ï¸ Mechaniker ${i + 1}` })),
  ];

  return `<div class="fade-in">
    <h2 style="margin-bottom:20px">ğŸ‘¥ Personal</h2>
    <div class="grid grid-2">
      ${allStaff.map(s => `
        <div class="card">
          <div class="card-header">
            <span>${s.roleLabel}</span>
            <span class="skill-badge ${skillClass(s.skill)}">${s.skill}</span>
          </div>
          <div style="font-weight:600;font-size:15px;margin-bottom:8px">${s.name}</div>
          <div style="display:flex;gap:14px;font-size:12px;color:var(--text-dim)">
            <span>ğŸ’° ${formatMoney(s.salary)}/Saison</span>
            <span>ğŸ“‹ ${s.contract} Jahr(e)</span>
            <span>ğŸ˜ƒ Moral ${s.morale}%</span>
          </div>
          <div style="margin-top:10px">
            <div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px"><span>Skill</span><span>${s.skill}/99</span></div>
            <div class="bar-wrap bar-cyan"><div class="bar-fill" style="width:${s.skill}%"></div></div>
          </div>
        </div>
      `).join('')}
    </div>
  </div>`;
}

function renderDevelopment() {
  const series = SERIES_DATA[G.series];
  const available = series.upgradesAvailable.filter(u => !G.car.upgrades.includes(u));

  return `<div class="fade-in">
    <h2 style="margin-bottom:20px">ğŸ”§ Entwicklung & Upgrades</h2>
    <div class="card">
      <div class="card-header">VerfÃ¼gbare Upgrades <span class="badge" style="background:var(--accent);color:#000">${available.length} verfÃ¼gbar</span></div>
      ${available.length === 0 ? '<p style="color:var(--text-dim);font-size:13px">Alle verfÃ¼gbaren Upgrades fÃ¼r diese Serie sind installiert!</p>' : ''}
      ${available.map(uid => {
        const u = UPGRADE_CATALOG[uid];
        const canAfford = G.budget >= u.cost;
        return `<div class="upgrade-item">
          <div class="upgrade-icon">${u.icon}</div>
          <div class="upgrade-info">
            <div class="upgrade-name">${u.name}</div>
            <div class="upgrade-desc">${u.desc}</div>
          </div>
          <div class="upgrade-cost">${formatMoney(u.cost)}</div>
          <button class="btn btn-small ${canAfford ? 'btn-success' : 'btn-secondary'}" ${canAfford ? '' : 'disabled'} onclick="buyUpgrade('${uid}')">
            ${canAfford ? 'Kaufen' : 'Zu teuer'}
          </button>
        </div>`;
      }).join('')}
    </div>
    <div class="card">
      <div class="card-header">Infrastruktur â€” Stufe ${G.infrastructure}/6</div>
      <div class="bar-wrap bar-cyan" style="height:10px;margin-bottom:12px"><div class="bar-fill" style="width:${G.infrastructure / 6 * 100}%"></div></div>
      <div style="display:grid;grid-template-columns:repeat(6,1fr);gap:6px;font-size:11px;text-align:center">
        ${[1,2,3,4,5,6].map(l => `<div style="padding:8px;border-radius:6px;border:1px solid ${l <= G.infrastructure ? 'var(--accent)' : 'var(--border)'};${l <= G.infrastructure ? 'background:var(--accent-glow)' : ''}">
          Stufe ${l}<br><span style="color:var(--text-dim)">${['Basis','Werkstatt','Telemetrie','Simulator','WindÂ­kanal','F1-Level'][l-1]}</span>
        </div>`).join('')}
      </div>
    </div>
  </div>`;
}

function renderFinances() {
  const sponsorIncome = G.finances.sponsorDeals.reduce((s, sp) => s + sp.amount, 0);
  const prizeIncome = G.history.reduce((s, h) => s + (h.prize || 0), 0);
  const totalDriverSalary = G.drivers.reduce((s, d) => s + d.salary, 0);
  const totalStaffSalary = [G.staff.engineer, G.staff.strategist, ...G.staff.mechanics].reduce((s, st) => s + st.salary, 0);
  const upgradeCosts = G.car.upgrades.reduce((s, u) => s + (UPGRADE_CATALOG[u]?.cost || 0), 0);

  return `<div class="fade-in">
    <h2 style="margin-bottom:20px">ğŸ’° Finanzen</h2>
    <div class="grid grid-3" style="margin-bottom:16px">
      <div class="card"><div class="stat"><span class="stat-label">Budget</span><span class="stat-value" style="color:var(--green)">${formatMoney(G.budget)}</span></div></div>
      <div class="card"><div class="stat"><span class="stat-label">Einnahmen (Saison)</span><span class="stat-value" style="color:var(--green)">${formatMoney(sponsorIncome + prizeIncome)}</span></div></div>
      <div class="card"><div class="stat"><span class="stat-label">Ausgaben (Saison)</span><span class="stat-value" style="color:var(--red)">${formatMoney(totalDriverSalary + totalStaffSalary + upgradeCosts)}</span></div></div>
    </div>
    <div class="grid grid-2">
      <div class="card">
        <div class="card-header">Einnahmen</div>
        ${G.finances.sponsorDeals.map(sp => `<div style="display:flex;justify-content:space-between;font-size:13px;padding:6px 0;border-bottom:1px solid rgba(30,41,59,.3)">
          <span>${sp.name}</span><span style="color:var(--green);font-weight:600">${formatMoney(sp.amount)}/Saison</span>
        </div>`).join('')}
        <div style="display:flex;justify-content:space-between;font-size:13px;padding:6px 0">
          <span>Preisgelder (bisher)</span><span style="color:var(--green);font-weight:600">${formatMoney(prizeIncome)}</span>
        </div>
      </div>
      <div class="card">
        <div class="card-header">Ausgaben</div>
        <div style="display:flex;justify-content:space-between;font-size:13px;padding:6px 0;border-bottom:1px solid rgba(30,41,59,.3)">
          <span>Fahrer-GehÃ¤lter</span><span style="color:var(--red);font-weight:600">${formatMoney(totalDriverSalary)}/Saison</span>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:13px;padding:6px 0;border-bottom:1px solid rgba(30,41,59,.3)">
          <span>Personal-GehÃ¤lter</span><span style="color:var(--red);font-weight:600">${formatMoney(totalStaffSalary)}/Saison</span>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:13px;padding:6px 0">
          <span>Upgrades</span><span style="color:var(--red);font-weight:600">${formatMoney(upgradeCosts)}</span>
        </div>
      </div>
    </div>
  </div>`;
}

function renderTransfers() {
  if (G.transfers.available.length === 0) generateTransferMarket();

  return `<div class="fade-in">
    <h2 style="margin-bottom:20px">ğŸ”„ Transfermarkt</h2>
    <div class="tabs">
      <div class="tab active" onclick="this.parentNode.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));this.classList.add('active');document.getElementById('transfer-drivers').style.display='block';document.getElementById('transfer-staff').style.display='none'">Fahrer</div>
      <div class="tab" onclick="this.parentNode.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));this.classList.add('active');document.getElementById('transfer-drivers').style.display='none';document.getElementById('transfer-staff').style.display='block'">Personal</div>
    </div>
    <div id="transfer-drivers">
      ${G.transfers.available.filter(t => t.type === 'driver').map(t => `
        <div class="driver-card" onclick="hireDriver('${t.data.id}')">
          <div class="driver-avatar" style="background:${pickRandom(TEAM_COLORS)}">${t.data.name.charAt(0)}</div>
          <div class="driver-info">
            <div class="driver-name">${t.data.nationality} ${t.data.name}</div>
            <div class="driver-meta">Alter ${t.data.age} Â· Potential ${t.data.potential} Â· ${formatMoney(t.data.salary)}/Saison</div>
          </div>
          <div class="driver-rating ${skillClass(avgSkill(t.data.skills))}">${avgSkill(t.data.skills)}</div>
        </div>
      `).join('')}
    </div>
    <div id="transfer-staff" style="display:none">
      ${G.transfers.available.filter(t => t.type === 'staff').map(t => `
        <div class="driver-card" onclick="hireStaff('${t.data.id}','${t.data.role}')">
          <div class="driver-avatar" style="background:var(--border-bright)">ğŸ‘¤</div>
          <div class="driver-info">
            <div class="driver-name">${t.data.name}</div>
            <div class="driver-meta">${t.data.role === 'engineer' ? 'Ingenieur' : t.data.role === 'strategist' ? 'Strategist' : 'Mechaniker'} Â· ${formatMoney(t.data.salary)}/Saison</div>
          </div>
          <div class="driver-rating ${skillClass(t.data.skill)}">${t.data.skill}</div>
        </div>
      `).join('')}
    </div>
    <button class="btn btn-secondary" style="margin-top:12px" onclick="G.transfers.available=[];generateTransferMarket();navigate('transfers')">ğŸ”„ Markt aktualisieren (${formatMoney(Math.round(SERIES_DATA[G.series].budget * 0.01))})</button>
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME LOGIC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function getAllDrivers() {
  const all = [...G.drivers];
  G.aiTeams.forEach(t => t.drivers.forEach(d => all.push(d)));
  return all;
}

function findDriverName(id) {
  const all = getAllDrivers();
  const d = all.find(d => d.id === id);
  return d ? d.name : '?';
}

function findDriverTeam(id) {
  if (G.drivers.some(d => d.id === id)) return G.teamName;
  for (const t of G.aiTeams) {
    if (t.drivers.some(d => d.id === id)) return t.name;
  }
  return '?';
}

function getSortedStandings() {
  return Object.entries(G.standings)
    .map(([id, pts]) => ({ id, pts, wins: 0 }))
    .sort((a, b) => b.pts - a.pts);
}

function getTeamStandings() {
  const teams = [];
  // Player team
  const playerPts = G.drivers.reduce((s, d) => s + (G.standings[d.id] || 0), 0);
  teams.push({ name: G.teamName, pts: playerPts, isPlayer: true });
  // AI teams
  G.aiTeams.forEach(t => {
    const pts = t.drivers.reduce((s, d) => s + (G.standings[d.id] || 0), 0);
    teams.push({ name: t.name, pts, isPlayer: false });
  });
  teams.sort((a, b) => b.pts - a.pts);
  return teams;
}

function getPlayerResult(results) {
  for (let i = 0; i < results.length; i++) {
    if (G.drivers.some(d => d.id === results[i].id)) {
      return `<span style="color:${i===0?'var(--gold)':i<3?'var(--accent)':'var(--text)'};font-weight:700">P${i + 1}</span>`;
    }
  }
  return '';
}

const POINTS_TABLE = [25, 18, 15, 12, 10, 8, 6, 4, 2, 1];
function getPoints(pos) { return POINTS_TABLE[pos] || 0; }

function formatLapTime(seconds) {
  const m = Math.floor(seconds / 60);
  const s = (seconds % 60).toFixed(3);
  return `${m}:${s.padStart(6, '0')}`;
}

function formatRaceTime(seconds) {
  const h = Math.floor(seconds / 3600);
  const m = Math.floor((seconds % 3600) / 60);
  const s = Math.floor(seconds % 60);
  if (h > 0) return `${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  return `${m}:${String(s).padStart(2,'0')}`;
}

function skillLabel(key) {
  const labels = {
    braking: 'Bremsen', cornering: 'Kurven', accelerating: 'Beschl.',
    tyre_mgmt: 'Reifenmgmt', fuel_mgmt: 'Sprit', consistency: 'Konstanz',
    wet_pace: 'Regen', racecraft: 'Racecraft', mental: 'Mental'
  };
  return labels[key] || key;
}

// â”€â”€â”€ SIMULATION ENGINE â”€â”€â”€
function simulateLapTime(driver, car, series, track, weather, engineerSkill, infraLevel, varianceScale = 1.0) {
  const sd = SERIES_DATA[series];
  const perf = car.performanceMult || { power: 1, aero: 1, grip: 1, wear: 1 };
  
  // Base lap time from track length and car performance
  const basePower = car.power * perf.power;
  const baseGrip = car.tireGrip * perf.grip;
  const baseCL = (car.cLWing + car.cLDiffuser) * perf.aero;
  
  // Approximate lap time using physics-inspired model:
  // t â‰ˆ trackLength / avgSpeed, where avgSpeed depends on power, grip, aero
  const trackLength = track.lengthKm * 1000;
  const powerFactor = Math.sqrt(basePower / 760000); // normalized to F1
  const gripFactor = baseGrip / 1.5;
  const aeroFactor = Math.sqrt(baseCL / 3.5);
  
  // Base speed estimation (simplified)
  const avgSpeedMps = 40 * powerFactor * Math.pow(gripFactor, 0.4) * Math.pow(aeroFactor, 0.3);
  let lapTime = trackLength / avgSpeedMps;

  // Driver skill effects
  const dSkills = driver.skills;
  const brakingFactor = 0.85 + (dSkills.braking / 99) * 0.15;
  const cornerFactor = 0.95 + (dSkills.cornering / 99) * 0.05;
  const accelFactor = 0.88 + (dSkills.accelerating / 99) * 0.12;
  const overallDriverFactor = (brakingFactor + cornerFactor + accelFactor) / 3;
  
  lapTime /= overallDriverFactor;

  // Engineer & setup quality
  const setupQuality = applySkillNoise(1.0, engineerSkill, 0.03, 0.01);
  lapTime /= Math.max(0.96, Math.min(1.04, setupQuality));

  // Consistency (random per-sector variation)
  const consistencyPenalty = (1 - dSkills.consistency / 99) * 0.05 * Math.random();
  lapTime *= (1 + consistencyPenalty);

  // Weather effect
  if (weather === 'light_rain') {
    const wetSkill = dSkills.wet_pace / 99;
    lapTime *= 1.08 - wetSkill * 0.04; // 4-8% slower in rain
  } else if (weather === 'heavy_rain') {
    const wetSkill = dSkills.wet_pace / 99;
    lapTime *= 1.15 - wetSkill * 0.07;
  }

  // Form & morale
  lapTime *= 1.0 - (driver.form - 50) / 5000;
  lapTime *= 1.0 - (driver.morale - 50) / 8000;

  // Random variance (natural lap-to-lap variation)
  lapTime += gaussianRandom() * 0.3 * varianceScale;

  return Math.max(lapTime * 0.9, lapTime); // sanity floor
}

function simulateSession(type) {
  const race = G.calendar.find(r => !r.completed);
  if (!race) return [];
  
  const allDrivers = getAllDrivers();
  const results = [];

  allDrivers.forEach(d => {
    const team = G.drivers.some(p => p.id === d.id) ? 
      { car: G.car, engineer: G.staff.engineer, infra: G.infrastructure } :
      (() => {
        const aiTeam = G.aiTeams.find(t => t.drivers.some(dr => dr.id === d.id));
        return {
          car: { ...SERIES_DATA[G.series].carDefaults, performanceMult: aiTeam.carPerformance },
          engineer: aiTeam.staff.engineer,
          infra: randInt(1, 4),
        };
      })();

    const varianceScale = type === 'fp' ? 1.5 : type === 'quali' ? 0.4 : 1.0;
    const time = simulateLapTime(d, team.car, G.series, race, race.weather, team.engineer.skill, team.infra, varianceScale);
    results.push({ id: d.id, time });
  });

  results.sort((a, b) => a.time - b.time);
  return results;
}

function simulateFullRace() {
  const race = G.calendar.find(r => !r.completed);
  if (!race) return [];
  
  const allDrivers = getAllDrivers();
  const results = [];
  const series = SERIES_DATA[G.series];

  allDrivers.forEach(d => {
    const team = G.drivers.some(p => p.id === d.id) ? 
      { car: G.car, engineer: G.staff.engineer, strategist: G.staff.strategist, infra: G.infrastructure, mechanics: G.staff.mechanics } :
      (() => {
        const aiTeam = G.aiTeams.find(t => t.drivers.some(dr => dr.id === d.id));
        return {
          car: { ...series.carDefaults, performanceMult: aiTeam.carPerformance },
          engineer: aiTeam.staff.engineer,
          strategist: aiTeam.staff.strategist || { skill: randInt(40, 70) },
          infra: randInt(1, 4),
          mechanics: [{ skill: randInt(40, 70) }, { skill: randInt(40, 70) }],
        };
      })();

    // Grid position affect (from quali)
    const ws = G.weekendState;
    let gridPenalty = 0;
    if (ws && ws.qualiResult) {
      const gridPos = ws.qualiResult.findIndex(r => r.id === d.id);
      gridPenalty = gridPos * 0.15; // 0.15s per grid position disadvantage on lap 1
    }

    // Simulate each lap
    let totalTime = gridPenalty;
    let tireDeg = 0;
    const laps = race.laps;
    
    // Pit stop timing (AI strategy)
    let pitLap = -1;
    let pitted = false;
    if (series.hasPitStops) {
      const stratSkill = team.strategist.skill;
      const optimalPit = Math.round(laps * 0.45); // ~45% through race
      pitLap = Math.round(applySkillNoise(optimalPit, stratSkill, laps * 0.15, 2));
      pitLap = clamp(pitLap, 3, laps - 2);
    }

    for (let lap = 0; lap < laps; lap++) {
      // Tire degradation (accumulates)
      tireDeg += (1 - d.skills.tyre_mgmt / 99) * 0.3 + 0.1;
      const tirePenalty = tireDeg * 0.02; // per % degradation

      // Pit stop
      if (series.hasPitStops && lap === pitLap && !pitted) {
        const mechSkill = team.mechanics[0]?.skill || 50;
        const pitBase = series.pitStopBase;
        const pitTime = pitBase * (1.3 - (mechSkill / 99) * 0.6) + gaussianRandom() * (2 - mechSkill / 50);
        
        // Pit error chance
        const errorChance = 0.005 + 0.145 * (1 - mechSkill / 99);
        const hasError = Math.random() < errorChance;
        totalTime += Math.max(pitBase * 0.7, pitTime) + (hasError ? randFloat(2, 8) : 0);
        
        tireDeg = 0; // Fresh tires
        pitted = true;
      }

      let lapTime = simulateLapTime(d, team.car, G.series, race, race.weather, team.engineer.skill, team.infra, 0.8);
      lapTime += tirePenalty;
      
      // Fuel effect (lighter car = faster) â€” linear from 2% penalty at full to 0%
      const fuelFactor = 1 + 0.02 * (1 - lap / laps);
      lapTime *= fuelFactor;

      // Safety car chance (rare, affects all equally)
      totalTime += lapTime;
    }

    // DNF chance (very low, depends on car reliability)
    const dnfChance = 0.02; // 2% per race
    const isDNF = Math.random() < dnfChance;

    results.push({ id: d.id, time: isDNF ? Infinity : totalTime, dnf: isDNF });
  });

  results.sort((a, b) => a.time - b.time);
  return results;
}

// â”€â”€â”€ GAME ACTIONS â”€â”€â”€
function startFP() {
  const ws = G.weekendState;
  ws.phase = 'fp';
  ws.fpResults = simulateSession('fp');
  ws.setupAdjustments = 0;
  renderPage();
  notify('Freies Training', `Ergebnis: P${ws.fpResults.findIndex(r => G.drivers.some(d => d.id === r.id)) + 1} fÃ¼r ${G.teamName}`);
}

function adjustSetup() {
  const ws = G.weekendState;
  if (ws.setupAdjustments >= 3) {
    notify('Setup', 'Keine weiteren Anpassungen mÃ¶glich!');
    return;
  }
  ws.setupAdjustments++;
  
  // Each adjustment improves car performance slightly for the weekend
  const improvement = G.staff.engineer.skill / 99 * 0.005;
  G.car.performanceMult.grip += improvement;
  G.car.performanceMult.aero += improvement * 0.5;
  
  // Re-run FP with improved setup
  ws.fpResults = simulateSession('fp');
  renderPage();
  notify('Setup angepasst', `Ingenieur ${G.staff.engineer.name} hat das Setup optimiert. Noch ${3 - ws.setupAdjustments} Anpassungen mÃ¶glich.`);
}

function startQuali() {
  const ws = G.weekendState;
  ws.phase = 'quali';
  ws.qualiResult = simulateSession('quali');
  renderPage();
  const myPos = ws.qualiResult.findIndex(r => G.drivers.some(d => d.id === r.id)) + 1;
  notify('Qualifying', `Startplatz P${myPos}!`);
}

function startRace() {
  const ws = G.weekendState;
  ws.phase = 'race_running';
  renderPage();
}

// â”€â”€â”€ RACEMODULE V1 INTEGRATION â”€â”€â”€
function launchRaceView() {
  const race = G.calendar.find(r => !r.completed);
  if (!race) return;
  const series = SERIES_DATA[G.series];
  const ws = G.weekendState;

  // Build grid data for RaceModuleV1
  const allDrivers = getAllDrivers();
  const gridOrder = ws.qualiResult ? ws.qualiResult.map(r => r.id) : allDrivers.map(d => d.id);

  const raceConfig = {
    source: 'MotorsportManager',
    teamName: G.teamName,
    series: G.series,
    seriesName: series.name,
    circuit: { name: race.name, laps: race.laps, lengthKm: race.lengthKm },
    weather: race.weather,
    carDefaults: series.carDefaults,
    grid: gridOrder.map((id, idx) => {
      const d = allDrivers.find(dr => dr.id === id);
      if (!d) return null;
      const isPlayer = G.drivers.some(p => p.id === id);
      const team = isPlayer ? { name: G.teamName, car: G.car, color: '#06b6d4' } :
        (() => {
          const aiT = G.aiTeams.find(t => t.drivers.some(dr => dr.id === id));
          return aiT ? { name: aiT.name, car: { ...series.carDefaults, performanceMult: aiT.carPerformance }, color: aiT.color } : null;
        })();
      if (!team) return null;
      return {
        position: idx + 1,
        driverId: id,
        driverName: d.name,
        teamName: team.name,
        color: team.color,
        isPlayer,
        skills: d.skills,
        car: {
          power: (team.car.power || series.carDefaults.power) * (team.car.performanceMult?.power || 1),
          mass: team.car.mass || series.carDefaults.mass,
          tireGrip: (team.car.tireGrip || series.carDefaults.tireGrip) * (team.car.performanceMult?.grip || 1),
          brakeForce: team.car.brakeForce || series.carDefaults.brakeForce,
          cLWing: (team.car.cLWing || series.carDefaults.cLWing) * (team.car.performanceMult?.aero || 1),
          cLDiffuser: (team.car.cLDiffuser || series.carDefaults.cLDiffuser) * (team.car.performanceMult?.aero || 1),
          cDBody: team.car.cDBody || series.carDefaults.cDBody,
          cDWing: team.car.cDWing || series.carDefaults.cDWing,
          frontalArea: team.car.frontalArea || series.carDefaults.frontalArea,
        }
      };
    }).filter(Boolean),
    hasPitStops: series.hasPitStops,
    pitStopBase: series.pitStopBase,
    timestamp: Date.now(),
  };

  // Write to localStorage so RaceModuleV1 can pick it up
  localStorage.setItem('MM_raceConfig', JSON.stringify(raceConfig));

  // Open RaceModuleV1 in new tab
  const raceWindow = window.open('RaceModuleV1.html', '_blank');

  // Listen for race result coming back
  const resultListener = (e) => {
    if (e.key === 'MM_raceResult') {
      try {
        const result = JSON.parse(e.newValue);
        if (result && result.timestamp > raceConfig.timestamp - 1000) {
          window.removeEventListener('storage', resultListener);
          localStorage.removeItem('MM_raceResult');
          receiveRaceResult(result);
        }
      } catch(err) { console.error('Result parse error:', err); }
    }
  };
  window.addEventListener('storage', resultListener);

  notify('RaceModule geÃ¶ffnet', 'Das Rennen lÃ¤uft im neuen Tab. Ergebnisse werden automatisch Ã¼bernommen.', 6000);
}

function receiveRaceResult(result) {
  const ws = G.weekendState;
  if (!ws || ws.phase !== 'race_running') return;

  // Convert RaceModule result to our format
  if (result.ranking && result.ranking.length > 0) {
    ws.raceResult = result.ranking.map(r => ({
      id: r.driverId || r.id,
      time: r.totalTime || r.time || 0,
      dnf: r.dnf || false,
    }));
  } else {
    // Fallback: simulate internally
    ws.raceResult = simulateFullRace();
  }

  ws.phase = 'finished';
  renderPage();
  notify('ğŸ Rennen beendet!', 'Ergebnisse aus dem RaceModule Ã¼bernommen.');
}

function simulateRace() {
  const ws = G.weekendState;
  ws.raceResult = simulateFullRace();
  ws.phase = 'finished';
  renderPage();
  
  const myBestPos = Math.min(...G.drivers.map(d => {
    const pos = ws.raceResult.findIndex(r => r.id === d.id);
    return pos >= 0 ? pos + 1 : 999;
  }));
  
  if (myBestPos === 1) notify('ğŸ† SIEG!', `${G.teamName} gewinnt das Rennen!`, 6000);
  else if (myBestPos <= 3) notify('ğŸ¥ˆ Podium!', `P${myBestPos} â€” Starkes Ergebnis!`, 5000);
  else notify('Rennergebnis', `Bestes Ergebnis: P${myBestPos}`);
}

function confirmRaceResult() {
  const ws = G.weekendState;
  const race = G.calendar.find(r => !r.completed);
  if (!race || !ws.raceResult) return;

  // Award points
  ws.raceResult.forEach((r, i) => {
    if (!r.dnf) {
      G.standings[r.id] = (G.standings[r.id] || 0) + getPoints(i);
    }
  });

  // Prize money for player
  G.drivers.forEach(d => {
    const pos = ws.raceResult.findIndex(r => r.id === d.id);
    if (pos >= 0 && pos < SERIES_DATA[G.series].prizePool.length) {
      const prize = SERIES_DATA[G.series].prizePool[pos];
      G.budget += prize;
      G.history.push({ round: race.round, circuit: race.name, position: pos + 1, prize, driverId: d.id });
    }
  });

  // Stats
  G.totalRaces++;
  const bestPos = Math.min(...G.drivers.map(d => {
    const pos = ws.raceResult.findIndex(r => r.id === d.id);
    return pos >= 0 ? pos + 1 : 999;
  }));
  if (bestPos === 1) G.wins++;
  if (bestPos <= 3) G.podiums++;

  // Reputation
  if (bestPos === 1) G.reputation += 5;
  else if (bestPos <= 3) G.reputation += 3;
  else if (bestPos <= 6) G.reputation += 1;

  // Driver development
  G.drivers.forEach(d => {
    d.experience += randInt(5, 15);
    // Skill growth based on potential gap
    Object.keys(d.skills).forEach(k => {
      if (d.skills[k] < d.potential && Math.random() < 0.15) {
        d.skills[k] = Math.min(d.potential, d.skills[k] + 1);
      }
    });
    // Form fluctuation
    d.form = clamp(d.form + randInt(-8, 12), 30, 100);
    // Morale based on result
    d.morale = clamp(d.morale + (bestPos <= 5 ? randInt(2, 8) : randInt(-5, 3)), 20, 100);
    // Age progression
    if (G.calendar.filter(r => r.completed).length === G.calendar.length - 1) d.age++;
  });

  // Undo weekend setup adjustments (they were temp)
  G.car.performanceMult.grip = Math.max(1.0, G.car.performanceMult.grip - G.weekendState.setupAdjustments * G.staff.engineer.skill / 99 * 0.005);
  G.car.performanceMult.aero = Math.max(1.0, G.car.performanceMult.aero - G.weekendState.setupAdjustments * G.staff.engineer.skill / 99 * 0.005 * 0.5);

  // Mark race completed
  race.completed = true;
  race.results = ws.raceResult;
  G.currentRound++;
  G.weekendState = null;

  // AI team development (they improve too!)
  G.aiTeams.forEach(t => {
    if (Math.random() < 0.15) {
      const cat = pickRandom(['power', 'aero', 'grip']);
      t.carPerformance[cat] += randFloat(0.001, 0.01);
    }
    t.drivers.forEach(d => {
      Object.keys(d.skills).forEach(k => {
        if (d.skills[k] < d.potential && Math.random() < 0.10) {
          d.skills[k] = Math.min(d.potential, d.skills[k] + 1);
        }
      });
    });
  });

  // Staff contracts
  [G.staff.engineer, G.staff.strategist, ...G.staff.mechanics].forEach(s => {
    s.morale = clamp(s.morale + randInt(-3, 5), 30, 100);
  });

  // Running costs
  const monthlyCost = Math.round((G.drivers.reduce((s, d) => s + d.salary, 0) + [G.staff.engineer, G.staff.strategist, ...G.staff.mechanics].reduce((s, st) => s + st.salary, 0)) / G.calendar.length);
  G.budget -= monthlyCost;

  // Check season end
  if (G.calendar.every(r => r.completed)) {
    notify('ğŸ Saison beendet!', `Saison ${G.season} ist vorbei! Gehe zum Dashboard fÃ¼r die Ergebnisse.`, 6000);
  }

  saveCareer();
  navigate('dashboard');
}

function buyUpgrade(uid) {
  const u = UPGRADE_CATALOG[uid];
  if (!u || G.budget < u.cost || G.car.upgrades.includes(uid)) return;
  
  G.budget -= u.cost;
  G.car.upgrades.push(uid);
  
  // Apply effects
  if (u.effect.power) G.car.performanceMult.power += u.effect.power;
  if (u.effect.aero) G.car.performanceMult.aero += u.effect.aero;
  if (u.effect.grip) G.car.performanceMult.grip += u.effect.grip;
  if (u.effect.wear) G.car.performanceMult.wear += u.effect.wear;
  if (u.effect.infra) G.infrastructure = Math.min(6, G.infrastructure + u.effect.infra);
  
  notify('Upgrade installiert!', `${u.name}: ${u.desc}`);
  saveCareer();
  renderPage();
}

function generateTransferMarket() {
  const series = SERIES_DATA[G.series];
  const available = [];
  
  // Generate 6-10 drivers
  for (let i = 0; i < randInt(6, 10); i++) {
    const dr = generateDriver([series.skillRange[0] - 5, series.skillRange[1] + 5], randInt(17, 35));
    available.push({ type: 'driver', data: dr });
  }
  
  // Generate 4-6 staff
  const roles = ['engineer', 'strategist', 'mechanic', 'mechanic'];
  for (let i = 0; i < randInt(4, 6); i++) {
    const role = pickRandom(roles);
    const st = generateStaffMember(role, [series.staffSkillRange[0] - 5, series.staffSkillRange[1] + 10]);
    available.push({ type: 'staff', data: st });
  }
  
  G.transfers.available = available;
}

function hireDriver(driverId) {
  const entry = G.transfers.available.find(t => t.type === 'driver' && t.data.id === driverId);
  if (!entry) return;
  
  const series = SERIES_DATA[G.series];
  const signingFee = Math.round(entry.data.salary * 0.5);
  
  if (G.budget < signingFee) {
    notify('Zu teuer!', `Signing Fee: ${formatMoney(signingFee)} â€” Budget reicht nicht.`);
    return;
  }
  
  if (G.drivers.length >= series.driversPerTeam) {
    // Need to release one driver first
    const worstDriver = G.drivers.reduce((w, d) => avgSkill(d.skills) < avgSkill(w.skills) ? d : w);
    if (avgSkill(entry.data.skills) <= avgSkill(worstDriver.skills)) {
      notify('Nicht besser', 'Dieser Fahrer ist nicht besser als deine aktuellen Fahrer.');
      return;
    }
    // Replace worst driver
    G.drivers = G.drivers.filter(d => d.id !== worstDriver.id);
    delete G.standings[worstDriver.id];
    notify('Fahrer getauscht', `${worstDriver.name} wurde entlassen.`);
  }
  
  G.budget -= signingFee;
  entry.data.contract = randInt(1, 3);
  G.drivers.push(entry.data);
  G.standings[entry.data.id] = 0;
  G.transfers.available = G.transfers.available.filter(t => t.data.id !== driverId);
  
  notify('Fahrer verpflichtet!', `${entry.data.name} (OVR ${avgSkill(entry.data.skills)}) hat unterschrieben! Fee: ${formatMoney(signingFee)}`);
  saveCareer();
  renderPage();
}

function hireStaff(staffId, role) {
  const entry = G.transfers.available.find(t => t.type === 'staff' && t.data.id === staffId);
  if (!entry) return;
  
  const signingFee = Math.round(entry.data.salary * 0.3);
  if (G.budget < signingFee) {
    notify('Zu teuer!', `Signing Fee: ${formatMoney(signingFee)} â€” Budget reicht nicht.`);
    return;
  }
  
  G.budget -= signingFee;
  entry.data.contract = randInt(1, 3);
  
  if (role === 'engineer') G.staff.engineer = entry.data;
  else if (role === 'strategist') G.staff.strategist = entry.data;
  else if (role === 'mechanic') {
    // Replace worst mechanic
    const worstIdx = G.staff.mechanics.reduce((wi, m, i, arr) => m.skill < arr[wi].skill ? i : wi, 0);
    G.staff.mechanics[worstIdx] = entry.data;
  }
  
  G.transfers.available = G.transfers.available.filter(t => t.data.id !== staffId);
  notify('Personal eingestellt!', `${entry.data.name} (Skill ${entry.data.skill}) ist im Team!`);
  saveCareer();
  renderPage();
}

function startNewSeason() {
  G.season++;
  
  // Generate new calendar
  const series = SERIES_DATA[G.series];
  G.calendar = series.circuits.map((c, i) => ({
    round: i + 1, ...c,
    weather: pickRandom(['sunny','sunny','sunny','cloudy','cloudy','light_rain']),
    completed: false, results: null,
  }));
  G.currentRound = 0;
  G.weekendState = null;
  
  // Reset standings
  const allDrivers = getAllDrivers();
  G.standings = {};
  allDrivers.forEach(d => { G.standings[d.id] = 0; });
  
  // Sponsor income
  const sponsorIncome = G.finances.sponsorDeals.reduce((s, sp) => s + sp.amount, 0);
  G.budget += sponsorIncome;
  
  // Sponsor deal expiry and renewal
  G.finances.sponsorDeals = G.finances.sponsorDeals.filter(sp => {
    sp.duration--;
    return sp.duration > 0;
  });
  if (G.finances.sponsorDeals.length === 0 || Math.random() < 0.4) {
    const newSponsor = {
      name: pickRandom(['TechCorp','SpeedFuel','AeroStar','GripMax','RaceWear','PitStop Pro','Velocity','Apex Energy','Podium','GridStart']) + ' ' + pickRandom(['Industries','Racing','Sport','Performance','Tech','']),
      amount: Math.round(randFloat(series.sponsorRange[0], series.sponsorRange[1]) * (1 + G.reputation / 200)),
      duration: randInt(1, 3),
    };
    G.finances.sponsorDeals.push(newSponsor);
    notify('Neuer Sponsor!', `${newSponsor.name}: ${formatMoney(newSponsor.amount)}/Saison fÃ¼r ${newSponsor.duration} Jahr(e)`);
  }
  
  // Contract expiry
  G.drivers.forEach(d => {
    d.contract--;
    if (d.contract <= 0) {
      d.contract = randInt(1, 3);
      d.salary = Math.round(d.salary * 1.15); // salary increase on renewal
    }
  });
  [G.staff.engineer, G.staff.strategist, ...G.staff.mechanics].forEach(s => {
    s.contract--;
    if (s.contract <= 0) {
      s.contract = randInt(1, 3);
      s.salary = Math.round(s.salary * 1.10);
    }
  });
  
  // Refresh transfer market
  G.transfers.available = [];
  
  saveCareer();
  navigate('dashboard');
  notify('Neue Saison!', `Saison ${G.season} der ${series.name} beginnt!`);
}

function attemptPromotion() {
  const currentSeries = SERIES_DATA[G.series];
  const nextSeriesId = currentSeries.nextSeries;
  if (!nextSeriesId) return;
  
  const nextSeries = SERIES_DATA[nextSeriesId];
  
  // Promote: switch series
  G.series = nextSeriesId;
  G.budget += Math.round(nextSeries.budget * 0.5); // Bonus budget for promotion
  G.reputation += 15;
  
  // Upgrade car to new series defaults
  G.car = { ...nextSeries.carDefaults, upgrades: [], performanceMult: { power: 1.0, aero: 1.0, grip: 1.0, wear: 1.0 } };
  
  // Generate new AI teams for new series
  const aiSkillMod = { easy: -10, normal: 0, hard: 8 };
  const numAITeams = Math.ceil((nextSeries.gridSize - nextSeries.driversPerTeam) / Math.max(1, nextSeries.driversPerTeam));
  G.aiTeams = [];
  for (let t = 0; t < numAITeams; t++) {
    const aiDrivers = [];
    for (let d = 0; d < nextSeries.driversPerTeam; d++) {
      const dr = generateDriver([nextSeries.skillRange[0] + aiSkillMod[G.difficulty], nextSeries.skillRange[1] + aiSkillMod[G.difficulty]]);
      aiDrivers.push(dr);
    }
    G.aiTeams.push({
      id: 'AI' + t,
      name: pickRandom(['Trident','Prema','ART','Carlin','MP','DAMS','UNI','Hitech','Campos','Charouz','Van Amersfoort','WRT','AF Corse','Iron Lynx','Rowe','Alpine Acad','RB Junior','Williams Acad','Sauber Acad','Haas Jr']) + ' Racing',
      color: TEAM_COLORS[t % TEAM_COLORS.length],
      drivers: aiDrivers,
      staff: {
        engineer: generateStaffMember('engineer', nextSeries.staffSkillRange),
        strategist: generateStaffMember('strategist', nextSeries.staffSkillRange),
      },
      carPerformance: { power: 1.0 + randFloat(-0.03, 0.03), aero: 1.0 + randFloat(-0.03, 0.03), grip: 1.0 + randFloat(-0.02, 0.02), wear: 1.0 + randFloat(-0.03, 0.03) },
      budget: Math.round(nextSeries.budget * randFloat(0.8, 1.3)),
    });
  }
  
  // If new series needs more drivers, add one
  while (G.drivers.length < nextSeries.driversPerTeam) {
    const nd = generateDriver(nextSeries.skillRange, randInt(19, 26));
    G.drivers.push(nd);
  }
  
  notify('ğŸ‰ AUFSTIEG!', `${G.teamName} steigt in die ${nextSeries.name} auf!`, 8000);
  startNewSeason();
}

// â”€â”€â”€ SAVE / LOAD â”€â”€â”€
function saveCareer() {
  try {
    localStorage.setItem('motorsport_manager_save', JSON.stringify(G));
    notify('ğŸ’¾ Gespeichert', 'Karriere wurde gespeichert.');
  } catch (e) {
    notify('Fehler', 'Speichern fehlgeschlagen: ' + e.message);
  }
}

function loadCareer() {
  try {
    const data = localStorage.getItem('motorsport_manager_save');
    if (data) {
      G = JSON.parse(data);
      document.getElementById('intro-screen').style.display = 'none';
      document.getElementById('app').style.display = 'flex';
      navigate('dashboard');
    }
  } catch (e) {
    notify('Fehler', 'Laden fehlgeschlagen: ' + e.message);
  }
}

// â”€â”€â”€ INTRO / START â”€â”€â”€
function showNewCareer() {
  openModal('modal-new-career');
}

function startNewCareer() {
  const teamName = document.getElementById('input-team-name').value.trim() || 'Apex Racing';
  const managerName = document.getElementById('input-manager-name').value.trim() || 'Manager';
  const series = document.getElementById('input-series').value;
  const difficulty = document.getElementById('input-difficulty').value;
  
  G = createNewGameState(teamName, managerName, series, difficulty);
  
  closeModal('modal-new-career');
  document.getElementById('intro-screen').style.display = 'none';
  document.getElementById('app').style.display = 'flex';
  
  navigate('dashboard');
  notify('ğŸ Karriere gestartet!', `${teamName} tritt in der ${SERIES_DATA[series].name} an. Viel Erfolg!`, 5000);
  saveCareer();
}

// â”€â”€â”€ INIT â”€â”€â”€
window.addEventListener('DOMContentLoaded', () => {
  // Check for saved game
  const saved = localStorage.getItem('motorsport_manager_save');
  if (saved) {
    try {
      const data = JSON.parse(saved);
      document.getElementById('continue-btn').style.display = 'block';
      document.getElementById('continue-desc').textContent = `${data.teamName} â€” ${SERIES_DATA[data.series]?.name || '?'} Saison ${data.season}`;
    } catch (e) {}
  }
});
</script>
</body>
</html>
